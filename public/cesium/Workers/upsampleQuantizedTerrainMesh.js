define(["./AttributeCompression-25f42564","./Transforms-ce97037a","./Cartesian2-38b35910","./when-ae2e0b60","./TerrainEncoding-ca220d73","./IndexDatatype-516320ea","./Check-f996273c","./Math-5bbcea10","./OrientedBoundingBox-155b5606","./createTaskProcessorWorker","./combine-276652d0","./RuntimeError-ac2797b4","./ComponentDatatype-e44126e4","./WebGLConstants-35626ea2","./EllipsoidTangentPlane-d3bb82f1","./AxisAlignedBoundingBox-26346796","./IntersectionTests-ce427234","./Plane-ee0aa150"],function(s,ue,oe,g,ae,pe,n,de,le,e,o,a,p,d,l,f,c,x){"use strict";var fe={clipTriangleAtAxisAlignedThreshold:function(e,t,i,n,s,r){g.defined(r)?r.length=0:r=[],t=t?(h=i<e,u=n<e,s<e):(h=e<i,u=e<n,e<s);var h,u,o,a,p,d,l,f,c=h+u+t;return 1===c?h?(o=(e-i)/(n-i),a=(e-i)/(s-i),r.push(1),r.push(2),1!==a&&(r.push(-1),r.push(0),r.push(2),r.push(a)),1!==o&&(r.push(-1),r.push(0),r.push(1),r.push(o))):u?(p=(e-n)/(s-n),d=(e-n)/(i-n),r.push(2),r.push(0),1!==d&&(r.push(-1),r.push(1),r.push(0),r.push(d)),1!==p&&(r.push(-1),r.push(1),r.push(2),r.push(p))):t&&(l=(e-s)/(i-s),f=(e-s)/(n-s),r.push(0),r.push(1),1!==f&&(r.push(-1),r.push(2),r.push(1),r.push(f)),1!==l)&&(r.push(-1),r.push(2),r.push(0),r.push(l)):2===c?h||i===e?u||n===e?t||s===e||(a=(e-i)/(s-i),p=(e-n)/(s-n),r.push(2),r.push(-1),r.push(0),r.push(2),r.push(a),r.push(-1),r.push(1),r.push(2),r.push(p)):(f=(e-s)/(n-s),o=(e-i)/(n-i),r.push(1),r.push(-1),r.push(2),r.push(1),r.push(f),r.push(-1),r.push(0),r.push(1),r.push(o)):(d=(e-n)/(i-n),l=(e-s)/(i-s),r.push(0),r.push(-1),r.push(1),r.push(0),r.push(d),r.push(-1),r.push(2),r.push(0),r.push(l)):3!==c&&(r.push(0),r.push(1),r.push(2)),r},computeBarycentricCoordinates:function(e,t,i,n,s,r,h,u,o){var i=i-h,s=h-s,r=r-u,n=n-u,a=1/(r*i+s*n),t=t-u,u=e-h,e=(r*u+s*t)*a,h=(-n*u+i*t)*a,r=1-e-h;return g.defined(o)?(o.x=e,o.y=h,o.z=r,o):new oe.Cartesian3(e,h,r)},computeLineSegmentLineSegmentIntersection:function(e,t,i,n,s,r,h,u,o){var a=(h-s)*(t-r)-(u-r)*(e-s),p=(i-e)*(t-r)-(n-t)*(e-s),u=(u-r)*(i-e)-(h-s)*(n-t);if(0!=u)return r=p/u,0<=(h=a/u)&&h<=1&&0<=r&&r<=1?((o=g.defined(o)?o:new oe.Cartesian2).x=e+h*(i-e),o.y=t+h*(n-t),o):void 0}},ce=32767,ge=16383,me=[],xe=[],we=[],Ce=new oe.Cartographic,ve=new oe.Cartesian3,Be=[],ye=[],Ie=[],Ae=[],be=[],Te=new oe.Cartesian3,ze=new ue.BoundingSphere,Me=new le.OrientedBoundingBox,Ne=new oe.Cartesian2,Ve=new oe.Cartesian3;function Ee(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}Ee.prototype.clone=function(e){return(e=g.defined(e)?e:new Ee).uBuffer=this.uBuffer,e.vBuffer=this.vBuffer,e.heightBuffer=this.heightBuffer,e.normalBuffer=this.normalBuffer,e.index=this.index,e.first=this.first,e.second=this.second,e.ratio=this.ratio,e},Ee.prototype.initializeIndexed=function(e,t,i,n,s){this.uBuffer=e,this.vBuffer=t,this.heightBuffer=i,this.normalBuffer=n,this.index=s,this.first=void 0,this.second=void 0,this.ratio=void 0},Ee.prototype.initializeFromClipResult=function(e,t,i){var n=t+1;return-1!==e[t]?i[e[t]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=i[e[n]],this.second=i[e[++n]],this.ratio=e[++n],++n),n},Ee.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},Ee.prototype.isIndexed=function(){return g.defined(this.index)},Ee.prototype.getH=function(){return g.defined(this.index)?this.heightBuffer[this.index]:de.CesiumMath.lerp(this.first.getH(),this.second.getH(),this.ratio)},Ee.prototype.getU=function(){return g.defined(this.index)?this.uBuffer[this.index]:de.CesiumMath.lerp(this.first.getU(),this.second.getU(),this.ratio)},Ee.prototype.getV=function(){return g.defined(this.index)?this.vBuffer[this.index]:de.CesiumMath.lerp(this.first.getV(),this.second.getV(),this.ratio)};var t=new oe.Cartesian2,r=-1,h=[new oe.Cartesian3,new oe.Cartesian3],u=[new oe.Cartesian3,new oe.Cartesian3];function i(e,t){var i=h[++r],n=u[r],i=s.AttributeCompression.octDecode(e.first.getNormalX(),e.first.getNormalY(),i),n=s.AttributeCompression.octDecode(e.second.getNormalX(),e.second.getNormalY(),n);return ve=oe.Cartesian3.lerp(i,n,e.ratio,ve),oe.Cartesian3.normalize(ve,ve),s.AttributeCompression.octEncode(ve,t),--r,t}Ee.prototype.getNormalX=function(){return g.defined(this.index)?this.normalBuffer[2*this.index]:(t=i(this,t)).x},Ee.prototype.getNormalY=function(){return g.defined(this.index)?this.normalBuffer[2*this.index+1]:(t=i(this,t)).y};var m=[];function Re(e,t,i,n,s,r,h,u,o){if(0!==h.length){for(var a=0,p=0;p<h.length;)p=m[a++].initializeFromClipResult(h,p,u);for(var d=0;d<a;++d){var l,f,c=m[d];c.isIndexed()?(c.newIndex=r[c.index],c.uBuffer=e,c.vBuffer=t,c.heightBuffer=i,o&&(c.normalBuffer=n)):(l=c.getKey(),g.defined(r[l])?c.newIndex=r[l]:(f=e.length,e.push(c.getU()),t.push(c.getV()),i.push(c.getH()),o&&(n.push(c.getNormalX()),n.push(c.getNormalY())),c.newIndex=f,r[l]=f))}3===a?(s.push(m[0].newIndex),s.push(m[1].newIndex),s.push(m[2].newIndex)):4===a&&(s.push(m[0].newIndex),s.push(m[1].newIndex),s.push(m[2].newIndex),s.push(m[0].newIndex),s.push(m[2].newIndex),s.push(m[3].newIndex))}}return m.push(new Ee),m.push(new Ee),m.push(new Ee),m.push(new Ee),e(function(e,U){for(var t=e.isEastChild,i=e.isNorthChild,F=t?ge:0,P=t?ce:ge,k=i?ge:0,D=i?ce:ge,n=Be,s=ye,r=Ie,h=be,u=(n.length=0,s.length=0,r.length=0,h.length=0,Ae),o=(u.length=0,{}),a=e.vertices,p=(p=e.indices).subarray(0,e.indexCountWithoutSkirts),d=ae.TerrainEncoding.clone(e.encoding),l=d.hasVertexNormals,W=0,f=e.vertexCountWithoutSkirts,c=e.minimumHeight,X=e.maximumHeight,g=new Array(f),m=new Array(f),x=new Array(f),w=l?new Array(2*f):void 0,C=0,v=0;C<f;++C,v+=2){var B=d.decodeTextureCoordinates(a,C,Ne),y=d.decodeHeight(a,C),I=de.CesiumMath.clamp(B.x*ce|0,0,ce),A=de.CesiumMath.clamp(B.y*ce|0,0,ce);x[C]=de.CesiumMath.clamp((y-c)/(X-c)*ce|0,0,ce),ce-(I=I<20?0:I)<20&&(I=ce),ce-(A=A<20?0:A)<20&&(A=ce),g[C]=I,m[C]=A,l&&(B=d.getOctEncodedNormal(a,C,Ve),w[v]=B.x,w[v+1]=B.y),(t&&ge<=I||!t&&I<=ge)&&(i&&ge<=A||!i&&A<=ge)&&(o[C]=W,n.push(I),s.push(A),r.push(x[C]),l&&(h.push(w[v]),h.push(w[v+1])),++W)}var b=[],T=(b.push(new Ee),b.push(new Ee),b.push(new Ee),[]);for(T.push(new Ee),T.push(new Ee),T.push(new Ee),C=0;C<p.length;C+=3){var z=p[C],M=p[C+1],K=p[C+2],L=g[z],Y=g[M],_=g[K],z=(b[0].initializeIndexed(g,m,x,w,z),b[1].initializeIndexed(g,m,x,w,M),b[2].initializeIndexed(g,m,x,w,K),fe.clipTriangleAtAxisAlignedThreshold(ge,t,L,Y,_,me));z.length<=0||(M=T[0].initializeFromClipResult(z,0,b))>=z.length||(M=T[1].initializeFromClipResult(z,M,b))>=z.length||(M=T[2].initializeFromClipResult(z,M,b),Re(n,s,r,h,u,o,fe.clipTriangleAtAxisAlignedThreshold(ge,i,T[0].getV(),T[1].getV(),T[2].getV(),xe),T,l),M<z.length&&(T[2].clone(T[1]),T[2].initializeFromClipResult(z,M,b),Re(n,s,r,h,u,o,fe.clipTriangleAtAxisAlignedThreshold(ge,i,T[0].getV(),T[1].getV(),T[2].getV(),xe),T,l)))}var G=t?-ce:0,J=i?-ce:0,Z=[],j=[],q=[],Q=[],N=Number.MAX_VALUE,V=-N,E=we,R=(E.length=0,oe.Ellipsoid.clone(e.ellipsoid)),$=(e=oe.Rectangle.clone(e.childRectangle)).north,ee=e.south,H=e.east,te=e.west;for(H<te&&(H+=de.CesiumMath.TWO_PI),C=0;C<n.length;++C)I=(I=Math.round(n[C]))<=F?(Z.push(C),0):P<=I?(q.push(C),ce):2*I+G,n[C]=I,A=(A=Math.round(s[C]))<=k?(j.push(C),0):D<=A?(Q.push(C),ce):2*A+J,s[C]=A,(y=de.CesiumMath.lerp(c,X,r[C]/ce))<N&&(N=y),V<y&&(V=y),r[C]=y,Ce.longitude=de.CesiumMath.lerp(te,H,I/ce),Ce.latitude=de.CesiumMath.lerp(ee,$,A/ce),Ce.height=y,R.cartographicToCartesian(Ce,ve),E.push(ve.x),E.push(ve.y),E.push(ve.z);var ie=ue.BoundingSphere.fromVertices(E,oe.Cartesian3.ZERO,3,ze),e=le.OrientedBoundingBox.fromRectangle(e,N,V,R,Me),ne=new ae.EllipsoidalOccluder(R).computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid(ie.center,E,3,ie.center,N,Te),se=V-N,O=new Uint16Array(n.length+s.length+r.length);for(C=0;C<n.length;++C)O[C]=n[C];var re=n.length;for(C=0;C<s.length;++C)O[re+C]=s[C];for(re+=s.length,C=0;C<r.length;++C)O[re+C]=ce*(r[C]-N)/se;var S,he=pe.IndexDatatype.createTypedArray(n.length,u);return l?(S=new Uint8Array(h),U.push(O.buffer,he.buffer,S.buffer),S=S.buffer):U.push(O.buffer,he.buffer),{vertices:O.buffer,encodedNormals:S,indices:he.buffer,minimumHeight:N,maximumHeight:V,westIndices:Z,southIndices:j,eastIndices:q,northIndices:Q,boundingSphere:ie,orientedBoundingBox:e,horizonOcclusionPoint:ne}})});
