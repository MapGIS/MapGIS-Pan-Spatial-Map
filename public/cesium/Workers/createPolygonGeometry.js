define(["./when-ae2e0b60","./Cartesian2-078e6458","./ArcType-1275a14e","./GeometryOffsetAttribute-b02d5bb9","./BoundingRectangle-7f4e0022","./Transforms-5aeb1d5e","./Check-f996273c","./ComponentDatatype-e44126e4","./EllipsoidGeodesic-e1197ec2","./EllipsoidTangentPlane-2b15994f","./GeometryAttribute-ccf4e0b6","./GeometryInstance-3287a41d","./GeometryPipeline-dd278883","./IndexDatatype-516320ea","./Math-5bbcea10","./PolygonGeometryLibrary-5bb2def1","./PolygonPipeline-01006d79","./VertexFormat-90d15264","./combine-276652d0","./RuntimeError-ac2797b4","./WebGLConstants-35626ea2","./AxisAlignedBoundingBox-3005be1a","./IntersectionTests-5403be00","./Plane-0ec594f2","./AttributeCompression-7a920947","./EncodedCartesian3-9b5052a5","./arrayRemoveDuplicates-bdf50aa0","./EllipsoidRhumbLine-d9133c69","./GeometryAttributes-5ce4955a"],function(W,Y,p,U,e,j,t,Q,m,G,q,O,V,F,K,D,L,f,o,r,a,n,s,l,u,c,h,_,P){"use strict";var Z=new Y.Cartographic,J=new Y.Cartographic;var N=new e.BoundingRectangle,X=new Y.Cartesian3,$=new Y.Cartesian3,ee=new Y.Cartesian3,te=new Y.Cartesian3,oe=new Y.Cartesian3,se=new Y.Cartesian3,re=new Y.Cartesian3,ae=new Y.Cartesian3,ie=new Y.Cartesian3,le=new Y.Cartesian2,ue=new Y.Cartesian2,ce=new Y.Cartesian3,ne=new j.Quaternion,pe=new j.Matrix3,me=new j.Matrix3;function H(e){var t,H,R,o,r,a=e.vertexFormat,i=e.geometry,n=e.shadowVolume,s=i.attributes.position.values,l=s.length,u=e.wall,c=e.top||u,p=e.bottom||u;if(a.st||a.normal||a.tangent||a.bitangent||n){var m,y,d=e.boundingRectangle,M=e.tangentPlane,g=e.ellipsoid,h=e.stRotation,S=e.st,f=e.perPositionHeight,B=le,b=(B.x=d.x,B.y=d.y,a.st?new Float32Array(l/3*2):void 0),_=(a.normal&&(m=f&&c&&!u?i.attributes.normal.values:new Float32Array(l)),a.tangent?new Float32Array(l):void 0),P=a.bitangent?new Float32Array(l):void 0,v=n?new Float32Array(l):void 0,C=0,x=0,w=$,T=ee,I=te,k=!0,A=pe,E=me,G=(E=0!==h?(y=j.Quaternion.fromAxisAngle(M._plane.normal,h,ne),A=j.Matrix3.fromQuaternion(y,A),y=j.Quaternion.fromAxisAngle(M._plane.normal,-h,ne),j.Matrix3.fromQuaternion(y,E)):(A=j.Matrix3.clone(j.Matrix3.IDENTITY,A),j.Matrix3.clone(j.Matrix3.IDENTITY,E)),0),z=0;c&&p&&(G=l/2,z=l/3,l/=2);for(var O=0;O<l;O+=3){var V,F,D,L,N=Y.Cartesian3.fromArray(s,O,ce);a.st&&!W.defined(S)&&(F=j.Matrix3.multiplyByVector(A,N,X),F=g.scaleToGeodeticSurface(F,F),F=M.projectPointOntoPlane(F,ue),Y.Cartesian2.subtract(F,B,F),V=K.CesiumMath.clamp(F.x/d.width,0,1),F=K.CesiumMath.clamp(F.y/d.height,0,1),p&&(b[C+z]=V,b[C+1+z]=F),c&&(b[C]=V,b[C+1]=F),C+=2),(a.normal||a.tangent||a.bitangent||n)&&(V=x+1,F=x+2,u?(O+3<l&&(D=Y.Cartesian3.fromArray(s,O+3,oe),k&&(L=Y.Cartesian3.fromArray(s,O+l,se),f&&(t=N,H=D,R=L,r=void 0,t=(o=g).cartesianToCartographic(t,Z).height,(r=o.cartesianToCartographic(H,J)).height=t,o.cartographicToCartesian(r,H),(r=o.cartesianToCartographic(R,J)).height=t-100,o.cartographicToCartesian(r,R)),Y.Cartesian3.subtract(D,N,D),Y.Cartesian3.subtract(L,N,L),w=Y.Cartesian3.normalize(Y.Cartesian3.cross(L,D,w),w),k=!1),Y.Cartesian3.equalsEpsilon(D,N,K.CesiumMath.EPSILON10))&&(k=!0),(a.tangent||a.bitangent)&&(I=g.geodeticSurfaceNormal(N,I),a.tangent)&&(T=Y.Cartesian3.normalize(Y.Cartesian3.cross(I,w,T),T))):(w=g.geodeticSurfaceNormal(N,w),(a.tangent||a.bitangent)&&(f&&(re=Y.Cartesian3.fromArray(m,x,re),ae=Y.Cartesian3.cross(Y.Cartesian3.UNIT_Z,re,ae),ae=Y.Cartesian3.normalize(j.Matrix3.multiplyByVector(E,ae,ae),ae),a.bitangent)&&(ie=Y.Cartesian3.normalize(Y.Cartesian3.cross(re,ae,ie),ie)),T=Y.Cartesian3.cross(Y.Cartesian3.UNIT_Z,w,T),T=Y.Cartesian3.normalize(j.Matrix3.multiplyByVector(E,T,T),T),a.bitangent)&&(I=Y.Cartesian3.normalize(Y.Cartesian3.cross(w,T,I),I))),a.normal&&(e.wall?(m[x+G]=w.x,m[V+G]=w.y,m[F+G]=w.z):p&&(m[x+G]=-w.x,m[V+G]=-w.y,m[F+G]=-w.z),c&&!f||u)&&(m[x]=w.x,m[V]=w.y,m[F]=w.z),n&&(u&&(w=g.geodeticSurfaceNormal(N,w)),v[x+G]=-w.x,v[V+G]=-w.y,v[F+G]=-w.z),a.tangent&&(e.wall?(_[x+G]=T.x,_[V+G]=T.y,_[F+G]=T.z):p&&(_[x+G]=-T.x,_[V+G]=-T.y,_[F+G]=-T.z),c)&&(f?(_[x]=ae.x,_[V]=ae.y,_[F]=ae.z):(_[x]=T.x,_[V]=T.y,_[F]=T.z)),a.bitangent&&(p&&(P[x+G]=I.x,P[V+G]=I.y,P[F+G]=I.z),c)&&(f?(P[x]=ie.x,P[V]=ie.y,P[F]=ie.z):(P[x]=I.x,P[V]=I.y,P[F]=I.z)),x+=3)}W.defined(S)&&(b=S),a.st&&(i.attributes.st=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:b})),a.normal&&(i.attributes.normal=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:m})),a.tangent&&(i.attributes.tangent=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:_})),a.bitangent&&(i.attributes.bitangent=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:P})),n&&(i.attributes.extrudeDirection=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:v}))}return e.extrude&&W.defined(e.offsetAttribute)&&(h=s.length/3,y=new Uint8Array(h),e.offsetAttribute===U.GeometryOffsetAttribute.TOP?c&&p||u?y=U.arrayFill(y,1,0,h/2):c&&(y=U.arrayFill(y,1)):(h=e.offsetAttribute===U.GeometryOffsetAttribute.NONE?0:1,y=U.arrayFill(y,h)),i.attributes.applyOffset=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:y})),i}var v=new Y.Cartographic,C=new Y.Cartographic,y={westOverIDL:0,eastOverIDL:0},d=new m.EllipsoidGeodesic;function i(e,t,o,r,a){if(a=W.defaultValue(a,new Y.Rectangle),!W.defined(e)||e.length<3)a.west=0,a.north=0,a.south=0,a.east=0;else{if(o===p.ArcType.RHUMB)return Y.Rectangle.fromCartesianArray(e,t,a);d.ellipsoid.equals(t)||(d=new m.EllipsoidGeodesic(void 0,void 0,t)),a.west=Number.POSITIVE_INFINITY,a.east=Number.NEGATIVE_INFINITY,a.south=Number.POSITIVE_INFINITY,a.north=Number.NEGATIVE_INFINITY,y.westOverIDL=Number.POSITIVE_INFINITY,y.eastOverIDL=Number.NEGATIVE_INFINITY;for(var i,n=1/K.CesiumMath.chordLength(r,t.maximumRadius),s=e.length,l=t.cartesianToCartographic(e[0],C),u=v,c=1;c<s;c++)i=u,u=l,l=t.cartesianToCartographic(e[c],i),d.setEndPoints(u,l),g(d,n,a,y);i=u,u=l,l=t.cartesianToCartographic(e[0],i),d.setEndPoints(u,l),g(d,n,a,y),a.east-a.west>y.eastOverIDL-y.westOverIDL&&(a.west=y.westOverIDL,a.east=y.eastOverIDL,a.east>K.CesiumMath.PI&&(a.east=a.east-K.CesiumMath.TWO_PI),a.west>K.CesiumMath.PI)&&(a.west=a.west-K.CesiumMath.TWO_PI)}return a}var x=new Y.Cartographic;function g(e,t,o,r){for(var a=e.surfaceDistance,i=Math.ceil(a*t),n=0<i?a/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var u=e.interpolateUsingSurfaceDistance(s,x),c=(s+=n,u.longitude),u=u.latitude,u=(o.west=Math.min(o.west,c),o.east=Math.max(o.east,c),o.south=Math.min(o.south,u),o.north=Math.max(o.north,u),0<=c?c:c+K.CesiumMath.TWO_PI);r.westOverIDL=Math.min(r.westOverIDL,u),r.eastOverIDL=Math.max(r.eastOverIDL,u)}}var R=[];function b(e){var t,o=e.polygonHierarchy,r=W.defaultValue(e.vertexFormat,f.VertexFormat.DEFAULT),a=W.defaultValue(e.ellipsoid,Y.Ellipsoid.WGS84),i=W.defaultValue(e.granularity,K.CesiumMath.RADIANS_PER_DEGREE),n=W.defaultValue(e.stRotation,0),s=W.defaultValue(e.perPositionHeight,!1),l=s&&W.defined(e.extrudedHeight),u=W.defaultValue(e.height,0),c=W.defaultValue(e.extrudedHeight,u);l||(t=Math.max(u,c),c=Math.min(u,c),u=t),this._vertexFormat=f.VertexFormat.clone(r),this._ellipsoid=Y.Ellipsoid.clone(a),this._granularity=i,this._indices=e.indices,this._st=e.st,this._stRotation=n,this._height=u,this._extrudedHeight=c,this._closeTop=W.defaultValue(e.closeTop,!0),this._closeBottom=W.defaultValue(e.closeBottom,!0),this._polygonHierarchy=o,this._perPositionHeight=s,this._perPositionHeightExtrude=l,this._shadowVolume=W.defaultValue(e.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=e.offsetAttribute,this._arcType=W.defaultValue(e.arcType,p.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=D.PolygonGeometryLibrary.computeHierarchyPackedLength(o)+Y.Ellipsoid.packedLength+f.VertexFormat.packedLength+12}b.fromPositions=function(e){return new b({polygonHierarchy:{positions:(e=W.defaultValue(e,W.defaultValue.EMPTY_OBJECT)).positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,indices:e.indices,st:e.st,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},b.pack=function(e,t,o){return o=W.defaultValue(o,0),o=D.PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,t,o),Y.Ellipsoid.pack(e._ellipsoid,t,o),o+=Y.Ellipsoid.packedLength,f.VertexFormat.pack(e._vertexFormat,t,o),o+=f.VertexFormat.packedLength,t[o++]=e._height,t[o++]=e._extrudedHeight,t[o++]=e._granularity,t[o++]=e._stRotation,t[o++]=e._perPositionHeightExtrude?1:0,t[o++]=e._perPositionHeight?1:0,t[o++]=e._closeTop?1:0,t[o++]=e._closeBottom?1:0,t[o++]=e._shadowVolume?1:0,t[o++]=W.defaultValue(e._offsetAttribute,-1),t[o++]=e._arcType,t[o]=e.packedLength,t};var w=Y.Ellipsoid.clone(Y.Ellipsoid.UNIT_SPHERE),T=new f.VertexFormat,I={polygonHierarchy:{}};return b.unpack=function(e,t,o){t=W.defaultValue(t,0);var r=D.PolygonGeometryLibrary.unpackPolygonHierarchy(e,t),a=(t=r.startingIndex,delete r.startingIndex,Y.Ellipsoid.unpack(e,t,w)),i=(t+=Y.Ellipsoid.packedLength,f.VertexFormat.unpack(e,t,T)),n=(t+=f.VertexFormat.packedLength,e[t++]),s=e[t++],l=e[t++],u=e[t++],c=1===e[t++],p=1===e[t++],m=1===e[t++],y=1===e[t++],d=1===e[t++],g=e[t++],h=e[t++],e=e[t];return(o=W.defined(o)?o:new b(I))._polygonHierarchy=r,o._ellipsoid=Y.Ellipsoid.clone(a,o._ellipsoid),o._vertexFormat=f.VertexFormat.clone(i,o._vertexFormat),o._height=n,o._extrudedHeight=s,o._granularity=l,o._stRotation=u,o._perPositionHeightExtrude=c,o._perPositionHeight=p,o._closeTop=m,o._closeBottom=y,o._shadowVolume=d,o._offsetAttribute=-1===g?void 0:g,o._arcType=h,o.packedLength=e,o},b.computeRectangle=function(e,t){var o=W.defaultValue(e.granularity,K.CesiumMath.RADIANS_PER_DEGREE),r=W.defaultValue(e.arcType,p.ArcType.GEODESIC),a=e.polygonHierarchy,e=W.defaultValue(e.ellipsoid,Y.Ellipsoid.WGS84);return i(a.positions,e,r,o,t)},b.createGeometry=function(e){var t=e._vertexFormat,o=e._ellipsoid,r=e._granularity,a=e._stRotation,i=e._indices,n=e._st,s=e._polygonHierarchy,l=e._perPositionHeight,u=e._closeTop,c=e._closeBottom,p=e._arcType,m=s.positions;if(!(m.length<3)){var y=G.EllipsoidTangentPlane.fromPoints(m,o),s=D.PolygonGeometryLibrary.polygonsFromHierarchy(s,y.projectPointsOntoPlane.bind(y),!l,o),d=s.hierarchy,g=s.polygons;if(0!==d.length){var h,m=d[0].outerRing,s=D.PolygonGeometryLibrary.computeBoundingRectangle(y.plane.normal,y.projectPointOntoPlane.bind(y),m,a,N),f=[],b=e._height,_=e._extrudedHeight,P={perPositionHeight:l,vertexFormat:t,geometry:void 0,tangentPlane:y,boundingRectangle:s,ellipsoid:o,stRotation:a,indices:i,st:n,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:p};if(e._perPositionHeightExtrude||!K.CesiumMath.equalsEpsilon(b,_,0,K.CesiumMath.EPSILON2))for(P.extrude=!0,P.top=u,P.bottom=c,P.shadowVolume=e._shadowVolume,P.offsetAttribute=e._offsetAttribute,h=0;h<g.length;h++){var v,C=function(e,t,o,r,a,i,n,s,l){var u={walls:[]};if(i||n){var t=D.PolygonGeometryLibrary.createGeometryFromPositions(e,t,o,a,s,l),c=t.attributes.position.values,p=t.indices;if(i&&n){for(var m,i=c.concat(c),y=i.length/3,d=((m=F.IndexDatatype.createTypedArray(y,2*p.length)).set(p),p.length),g=y/2,h=0;h<d;h+=3){var f=m[h]+g,b=m[h+1]+g,_=m[h+2]+g;m[h+d]=_,m[h+1+d]=b,m[h+2+d]=f}t.attributes.position.values=i,a&&s.normal&&(s=t.attributes.normal.values,t.attributes.normal.values=new Float32Array(i.length),t.attributes.normal.values.set(s)),t.indices=m}else if(n){for(y=c.length/3,m=F.IndexDatatype.createTypedArray(y,p.length),h=0;h<p.length;h+=3)m[h]=p[h+2],m[h+1]=p[h+1],m[h+2]=p[h];t.indices=m}u.topAndBottom=new O.GeometryInstance({geometry:t})}var i=r.outerRing,P=G.EllipsoidTangentPlane.fromPoints(i,e).projectPointsOntoPlane(i,R),v=(L.PolygonPipeline.computeWindingOrder2D(P)===L.WindingOrder.CLOCKWISE&&(i=i.slice().reverse()),D.PolygonGeometryLibrary.computeWallGeometry(i,e,o,a,l)),C=(u.walls.push(new O.GeometryInstance({geometry:v})),r.holes);for(h=0;h<C.length;h++){var x=C[h],P=G.EllipsoidTangentPlane.fromPoints(x,e).projectPointsOntoPlane(x,R);L.PolygonPipeline.computeWindingOrder2D(P)===L.WindingOrder.COUNTER_CLOCKWISE&&(x=x.slice().reverse()),v=D.PolygonGeometryLibrary.computeWallGeometry(x,e,o,a,l),u.walls.push(new O.GeometryInstance({geometry:v}))}return u}(o,g[h],r,d[h],l,u,c,t,p),x=(u&&c?(v=C.topAndBottom,P.geometry=D.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(v.geometry,b,_,o,l)):u?((v=C.topAndBottom).geometry.attributes.position.values=L.PolygonPipeline.scaleToGeodeticHeight(v.geometry.attributes.position.values,b,o,!l),P.geometry=v.geometry):c&&((v=C.topAndBottom).geometry.attributes.position.values=L.PolygonPipeline.scaleToGeodeticHeight(v.geometry.attributes.position.values,_,o,!0),P.geometry=v.geometry),(u||c)&&(P.wall=!1,v.geometry=H(P),f.push(v)),C.walls);P.wall=!0;for(var w=0;w<x.length;w++){var T=x[w];P.geometry=D.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(T.geometry,b,_,o,l),T.geometry=H(P),f.push(T)}}else for(h=0;h<g.length;h++){var I,A,E=new O.GeometryInstance({geometry:D.PolygonGeometryLibrary.createGeometryFromPositions(o,g[h],r,l,t,p)});E.geometry.attributes.position.values=L.PolygonPipeline.scaleToGeodeticHeight(E.geometry.attributes.position.values,b,o,!l),P.indices&&l&&(E.geometry.indices=P.indices),P.geometry=E.geometry,E.geometry=H(P),W.defined(e._offsetAttribute)&&(I=E.geometry.attributes.position.values.length,I=new Uint8Array(I/3),A=e._offsetAttribute===U.GeometryOffsetAttribute.NONE?0:1,U.arrayFill(I,A),E.geometry.attributes.applyOffset=new q.GeometryAttribute({componentDatatype:Q.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:I})),f.push(E)}m=V.GeometryPipeline.combineInstances(f)[0],y=(m.attributes.position.values=new Float64Array(m.attributes.position.values),m.indices=F.IndexDatatype.createTypedArray(m.attributes.position.values.length/3,m.indices),m.attributes),s=j.BoundingSphere.fromVertices(y.position.values);return t.position||delete y.position,new q.Geometry({attributes:y,indices:m.indices,primitiveType:m.primitiveType,boundingSphere:s,offsetAttribute:e._offsetAttribute})}}},b.createShadowVolume=function(e,t,o){var r=e._granularity,a=e._ellipsoid,t=t(r,a),o=o(r,a);return new b({polygonHierarchy:e._polygonHierarchy,ellipsoid:a,stRotation:e._stRotation,granularity:r,perPositionHeight:!1,extrudedHeight:t,height:o,vertexFormat:f.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(b.prototype,{rectangle:{get:function(){var e;return W.defined(this._rectangle)||(e=this._polygonHierarchy.positions,this._rectangle=i(e,this._ellipsoid,this._arcType,this._granularity)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){var e,t,o,r;return W.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=0==(r=-(e=this)._stRotation)?[0,0,0,1,1,0]:(t=e._ellipsoid,o=e._polygonHierarchy.positions,e=e.rectangle,q.Geometry._textureCoordinateRotationPoints(o,r,t,e))),this._textureCoordinateRotationPoints}}}),function(e,t){return(e=W.defined(t)?b.unpack(e,t):e)._ellipsoid=Y.Ellipsoid.clone(e._ellipsoid),b.createGeometry(e)}});
