define(["./when-ae2e0b60","./Cartesian2-38b35910","./ArcType-1275a14e","./GeometryOffsetAttribute-b02d5bb9","./BoundingRectangle-843e0741","./Transforms-f0fd44c2","./Check-f996273c","./ComponentDatatype-e44126e4","./EllipsoidGeodesic-0207b202","./EllipsoidTangentPlane-b2a9e6a0","./GeometryAttribute-0e25489a","./GeometryInstance-0498c71f","./GeometryPipeline-592f8e72","./IndexDatatype-516320ea","./Math-5bbcea10","./PolygonGeometryLibrary-be0c11cf","./PolygonPipeline-0d0d24fa","./VertexFormat-90d15264","./combine-276652d0","./RuntimeError-ac2797b4","./WebGLConstants-35626ea2","./AxisAlignedBoundingBox-d4b404f7","./IntersectionTests-8ca4dd3d","./Plane-9e1b50ea","./AttributeCompression-25f42564","./EncodedCartesian3-d40e98d6","./arrayRemoveDuplicates-bdf50aa0","./EllipsoidRhumbLine-af7b5ebe","./GeometryAttributes-5ce4955a"],function(z,W,c,Y,e,U,t,j,m,A,Q,E,G,O,q,V,F,f,o,r,a,n,s,l,u,p,h,_,P){"use strict";var K=new W.Cartographic,Z=new W.Cartographic;var D=new e.BoundingRectangle,J=new W.Cartesian3,X=new W.Cartesian3,$=new W.Cartesian3,ee=new W.Cartesian3,te=new W.Cartesian3,ne=new W.Cartesian3,oe=new W.Cartesian3,re=new W.Cartesian3,ae=new W.Cartesian3,se=new W.Cartesian2,le=new W.Cartesian2,ue=new W.Cartesian3,ie=new U.Quaternion,pe=new U.Matrix3,ce=new U.Matrix3;function L(e){var t,H,R,o,r,a=e.vertexFormat,i=e.geometry,n=e.shadowVolume,s=i.attributes.position.values,l=s.length,u=e.wall,p=e.top||u,c=e.bottom||u;if(a.st||a.normal||a.tangent||a.bitangent||n){var m,y,g=e.boundingRectangle,M=e.tangentPlane,d=e.ellipsoid,h=e.stRotation,f=e.perPositionHeight,S=se,b=(S.x=g.x,S.y=g.y,a.st?new Float32Array(l/3*2):void 0),_=(a.normal&&(m=f&&p&&!u?i.attributes.normal.values:new Float32Array(l)),a.tangent?new Float32Array(l):void 0),P=a.bitangent?new Float32Array(l):void 0,v=n?new Float32Array(l):void 0,C=0,x=0,w=X,T=$,I=ee,B=!0,A=pe,E=ce,G=(E=0!==h?(y=U.Quaternion.fromAxisAngle(M._plane.normal,h,ie),A=U.Matrix3.fromQuaternion(y,A),y=U.Quaternion.fromAxisAngle(M._plane.normal,-h,ie),U.Matrix3.fromQuaternion(y,E)):(A=U.Matrix3.clone(U.Matrix3.IDENTITY,A),U.Matrix3.clone(U.Matrix3.IDENTITY,E)),0),k=0;p&&c&&(G=l/2,k=l/3,l/=2);for(var O=0;O<l;O+=3){var V,F,D,L,N=W.Cartesian3.fromArray(s,O,ue);a.st&&(F=U.Matrix3.multiplyByVector(A,N,J),F=d.scaleToGeodeticSurface(F,F),F=M.projectPointOntoPlane(F,le),W.Cartesian2.subtract(F,S,F),V=q.CesiumMath.clamp(F.x/g.width,0,1),F=q.CesiumMath.clamp(F.y/g.height,0,1),c&&(b[C+k]=V,b[C+1+k]=F),p&&(b[C]=V,b[C+1]=F),C+=2),(a.normal||a.tangent||a.bitangent||n)&&(V=x+1,F=x+2,u?(O+3<l&&(D=W.Cartesian3.fromArray(s,O+3,te),B&&(L=W.Cartesian3.fromArray(s,O+l,ne),f&&(t=N,H=D,R=L,r=void 0,t=(o=d).cartesianToCartographic(t,K).height,(r=o.cartesianToCartographic(H,Z)).height=t,o.cartographicToCartesian(r,H),(r=o.cartesianToCartographic(R,Z)).height=t-100,o.cartographicToCartesian(r,R)),W.Cartesian3.subtract(D,N,D),W.Cartesian3.subtract(L,N,L),w=W.Cartesian3.normalize(W.Cartesian3.cross(L,D,w),w),B=!1),W.Cartesian3.equalsEpsilon(D,N,q.CesiumMath.EPSILON10)&&(B=!0)),(a.tangent||a.bitangent)&&(I=d.geodeticSurfaceNormal(N,I),a.tangent&&(T=W.Cartesian3.normalize(W.Cartesian3.cross(I,w,T),T)))):(w=d.geodeticSurfaceNormal(N,w),(a.tangent||a.bitangent)&&(f&&(oe=W.Cartesian3.fromArray(m,x,oe),re=W.Cartesian3.cross(W.Cartesian3.UNIT_Z,oe,re),re=W.Cartesian3.normalize(U.Matrix3.multiplyByVector(E,re,re),re),a.bitangent&&(ae=W.Cartesian3.normalize(W.Cartesian3.cross(oe,re,ae),ae))),T=W.Cartesian3.cross(W.Cartesian3.UNIT_Z,w,T),T=W.Cartesian3.normalize(U.Matrix3.multiplyByVector(E,T,T),T),a.bitangent&&(I=W.Cartesian3.normalize(W.Cartesian3.cross(w,T,I),I)))),a.normal&&(e.wall?(m[x+G]=w.x,m[V+G]=w.y,m[F+G]=w.z):c&&(m[x+G]=-w.x,m[V+G]=-w.y,m[F+G]=-w.z),(p&&!f||u)&&(m[x]=w.x,m[V]=w.y,m[F]=w.z)),n&&(u&&(w=d.geodeticSurfaceNormal(N,w)),v[x+G]=-w.x,v[V+G]=-w.y,v[F+G]=-w.z),a.tangent&&(e.wall?(_[x+G]=T.x,_[V+G]=T.y,_[F+G]=T.z):c&&(_[x+G]=-T.x,_[V+G]=-T.y,_[F+G]=-T.z),p&&(f?(_[x]=re.x,_[V]=re.y,_[F]=re.z):(_[x]=T.x,_[V]=T.y,_[F]=T.z))),a.bitangent&&(c&&(P[x+G]=I.x,P[V+G]=I.y,P[F+G]=I.z),p&&(f?(P[x]=ae.x,P[V]=ae.y,P[F]=ae.z):(P[x]=I.x,P[V]=I.y,P[F]=I.z))),x+=3)}a.st&&(i.attributes.st=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:b})),a.normal&&(i.attributes.normal=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:m})),a.tangent&&(i.attributes.tangent=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:_})),a.bitangent&&(i.attributes.bitangent=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:P})),n&&(i.attributes.extrudeDirection=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:v}))}return e.extrude&&z.defined(e.offsetAttribute)&&(h=s.length/3,y=new Uint8Array(h),e.offsetAttribute===Y.GeometryOffsetAttribute.TOP?p&&c||u?y=Y.arrayFill(y,1,0,h/2):p&&(y=Y.arrayFill(y,1)):(h=e.offsetAttribute===Y.GeometryOffsetAttribute.NONE?0:1,y=Y.arrayFill(y,h)),i.attributes.applyOffset=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:y})),i}var v=new W.Cartographic,C=new W.Cartographic,y={westOverIDL:0,eastOverIDL:0},g=new m.EllipsoidGeodesic;function i(e,t,o,r,a){if(a=z.defaultValue(a,new W.Rectangle),!z.defined(e)||e.length<3)return a.west=0,a.north=0,a.south=0,a.east=0,a;if(o===c.ArcType.RHUMB)return W.Rectangle.fromCartesianArray(e,t,a);g.ellipsoid.equals(t)||(g=new m.EllipsoidGeodesic(void 0,void 0,t)),a.west=Number.POSITIVE_INFINITY,a.east=Number.NEGATIVE_INFINITY,a.south=Number.POSITIVE_INFINITY,a.north=Number.NEGATIVE_INFINITY,y.westOverIDL=Number.POSITIVE_INFINITY,y.eastOverIDL=Number.NEGATIVE_INFINITY;for(var i,n=1/q.CesiumMath.chordLength(r,t.maximumRadius),s=e.length,l=t.cartesianToCartographic(e[0],C),u=v,p=1;p<s;p++)i=u,u=l,l=t.cartesianToCartographic(e[p],i),g.setEndPoints(u,l),d(g,n,a,y);return i=u,u=l,l=t.cartesianToCartographic(e[0],i),g.setEndPoints(u,l),d(g,n,a,y),a.east-a.west>y.eastOverIDL-y.westOverIDL&&(a.west=y.westOverIDL,a.east=y.eastOverIDL,a.east>q.CesiumMath.PI&&(a.east=a.east-q.CesiumMath.TWO_PI),a.west>q.CesiumMath.PI&&(a.west=a.west-q.CesiumMath.TWO_PI)),a}var x=new W.Cartographic;function d(e,t,o,r){for(var a=e.surfaceDistance,i=Math.ceil(a*t),n=0<i?a/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var u=e.interpolateUsingSurfaceDistance(s,x),p=(s+=n,u.longitude),u=u.latitude,u=(o.west=Math.min(o.west,p),o.east=Math.max(o.east,p),o.south=Math.min(o.south,u),o.north=Math.max(o.north,u),0<=p?p:p+q.CesiumMath.TWO_PI);r.westOverIDL=Math.min(r.westOverIDL,u),r.eastOverIDL=Math.max(r.eastOverIDL,u)}}var N=[];function b(e){var t,o=e.polygonHierarchy,r=z.defaultValue(e.vertexFormat,f.VertexFormat.DEFAULT),a=z.defaultValue(e.ellipsoid,W.Ellipsoid.WGS84),i=z.defaultValue(e.granularity,q.CesiumMath.RADIANS_PER_DEGREE),n=z.defaultValue(e.stRotation,0),s=z.defaultValue(e.perPositionHeight,!1),l=s&&z.defined(e.extrudedHeight),u=z.defaultValue(e.height,0),p=z.defaultValue(e.extrudedHeight,u);l||(t=Math.max(u,p),p=Math.min(u,p),u=t),this._vertexFormat=f.VertexFormat.clone(r),this._ellipsoid=W.Ellipsoid.clone(a),this._granularity=i,this._stRotation=n,this._height=u,this._extrudedHeight=p,this._closeTop=z.defaultValue(e.closeTop,!0),this._closeBottom=z.defaultValue(e.closeBottom,!0),this._polygonHierarchy=o,this._perPositionHeight=s,this._perPositionHeightExtrude=l,this._shadowVolume=z.defaultValue(e.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=e.offsetAttribute,this._arcType=z.defaultValue(e.arcType,c.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=V.PolygonGeometryLibrary.computeHierarchyPackedLength(o)+W.Ellipsoid.packedLength+f.VertexFormat.packedLength+12}b.fromPositions=function(e){return new b({polygonHierarchy:{positions:(e=z.defaultValue(e,z.defaultValue.EMPTY_OBJECT)).positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},b.pack=function(e,t,o){return o=z.defaultValue(o,0),o=V.PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,t,o),W.Ellipsoid.pack(e._ellipsoid,t,o),o+=W.Ellipsoid.packedLength,f.VertexFormat.pack(e._vertexFormat,t,o),o+=f.VertexFormat.packedLength,t[o++]=e._height,t[o++]=e._extrudedHeight,t[o++]=e._granularity,t[o++]=e._stRotation,t[o++]=e._perPositionHeightExtrude?1:0,t[o++]=e._perPositionHeight?1:0,t[o++]=e._closeTop?1:0,t[o++]=e._closeBottom?1:0,t[o++]=e._shadowVolume?1:0,t[o++]=z.defaultValue(e._offsetAttribute,-1),t[o++]=e._arcType,t[o]=e.packedLength,t};var w=W.Ellipsoid.clone(W.Ellipsoid.UNIT_SPHERE),T=new f.VertexFormat,I={polygonHierarchy:{}};return b.unpack=function(e,t,o){t=z.defaultValue(t,0);var r=V.PolygonGeometryLibrary.unpackPolygonHierarchy(e,t),a=(t=r.startingIndex,delete r.startingIndex,W.Ellipsoid.unpack(e,t,w)),i=(t+=W.Ellipsoid.packedLength,f.VertexFormat.unpack(e,t,T)),n=(t+=f.VertexFormat.packedLength,e[t++]),s=e[t++],l=e[t++],u=e[t++],p=1===e[t++],c=1===e[t++],m=1===e[t++],y=1===e[t++],g=1===e[t++],d=e[t++],h=e[t++],e=e[t];return(o=z.defined(o)?o:new b(I))._polygonHierarchy=r,o._ellipsoid=W.Ellipsoid.clone(a,o._ellipsoid),o._vertexFormat=f.VertexFormat.clone(i,o._vertexFormat),o._height=n,o._extrudedHeight=s,o._granularity=l,o._stRotation=u,o._perPositionHeightExtrude=p,o._perPositionHeight=c,o._closeTop=m,o._closeBottom=y,o._shadowVolume=g,o._offsetAttribute=-1===d?void 0:d,o._arcType=h,o.packedLength=e,o},b.computeRectangle=function(e,t){var o=z.defaultValue(e.granularity,q.CesiumMath.RADIANS_PER_DEGREE),r=z.defaultValue(e.arcType,c.ArcType.GEODESIC),a=e.polygonHierarchy,e=z.defaultValue(e.ellipsoid,W.Ellipsoid.WGS84);return i(a.positions,e,r,o,t)},b.createGeometry=function(e){var t=e._vertexFormat,o=e._ellipsoid,r=e._granularity,a=e._stRotation,i=e._polygonHierarchy,n=e._perPositionHeight,s=e._closeTop,l=e._closeBottom,u=e._arcType,p=i.positions;if(!(p.length<3)){var c=A.EllipsoidTangentPlane.fromPoints(p,o),i=V.PolygonGeometryLibrary.polygonsFromHierarchy(i,c.projectPointsOntoPlane.bind(c),!n,o),m=i.hierarchy,y=i.polygons;if(0!==m.length){var g,p=m[0].outerRing,i=V.PolygonGeometryLibrary.computeBoundingRectangle(c.plane.normal,c.projectPointOntoPlane.bind(c),p,a,D),d=[],h=e._height,f=e._extrudedHeight,b={perPositionHeight:n,vertexFormat:t,geometry:void 0,tangentPlane:c,boundingRectangle:i,ellipsoid:o,stRotation:a,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:u};if(e._perPositionHeightExtrude||!q.CesiumMath.equalsEpsilon(h,f,0,q.CesiumMath.EPSILON2))for(b.extrude=!0,b.top=s,b.bottom=l,b.shadowVolume=e._shadowVolume,b.offsetAttribute=e._offsetAttribute,g=0;g<y.length;g++){var _,P=function(e,t,o,r,a,i,n,s,l){var u={walls:[]};if(i||n){var t=V.PolygonGeometryLibrary.createGeometryFromPositions(e,t,o,a,s,l),p=t.attributes.position.values,c=t.indices;if(i&&n){for(var m,i=p.concat(p),y=i.length/3,g=((m=O.IndexDatatype.createTypedArray(y,2*c.length)).set(c),c.length),d=y/2,h=0;h<g;h+=3){var f=m[h]+d,b=m[h+1]+d,_=m[h+2]+d;m[h+g]=_,m[h+1+g]=b,m[h+2+g]=f}t.attributes.position.values=i,a&&s.normal&&(s=t.attributes.normal.values,t.attributes.normal.values=new Float32Array(i.length),t.attributes.normal.values.set(s)),t.indices=m}else if(n){for(y=p.length/3,m=O.IndexDatatype.createTypedArray(y,c.length),h=0;h<c.length;h+=3)m[h]=c[h+2],m[h+1]=c[h+1],m[h+2]=c[h];t.indices=m}u.topAndBottom=new E.GeometryInstance({geometry:t})}var i=r.outerRing,P=A.EllipsoidTangentPlane.fromPoints(i,e).projectPointsOntoPlane(i,N),v=(F.PolygonPipeline.computeWindingOrder2D(P)===F.WindingOrder.CLOCKWISE&&(i=i.slice().reverse()),V.PolygonGeometryLibrary.computeWallGeometry(i,e,o,a,l)),C=(u.walls.push(new E.GeometryInstance({geometry:v})),r.holes);for(h=0;h<C.length;h++){var x=C[h],P=A.EllipsoidTangentPlane.fromPoints(x,e).projectPointsOntoPlane(x,N);F.PolygonPipeline.computeWindingOrder2D(P)===F.WindingOrder.COUNTER_CLOCKWISE&&(x=x.slice().reverse()),v=V.PolygonGeometryLibrary.computeWallGeometry(x,e,o,a,l),u.walls.push(new E.GeometryInstance({geometry:v}))}return u}(o,y[g],r,m[g],n,s,l,t,u),v=(s&&l?(_=P.topAndBottom,b.geometry=V.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(_.geometry,h,f,o,n)):s?((_=P.topAndBottom).geometry.attributes.position.values=F.PolygonPipeline.scaleToGeodeticHeight(_.geometry.attributes.position.values,h,o,!n),b.geometry=_.geometry):l&&((_=P.topAndBottom).geometry.attributes.position.values=F.PolygonPipeline.scaleToGeodeticHeight(_.geometry.attributes.position.values,f,o,!0),b.geometry=_.geometry),(s||l)&&(b.wall=!1,_.geometry=L(b),d.push(_)),P.walls);b.wall=!0;for(var C=0;C<v.length;C++){var x=v[C];b.geometry=V.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(x.geometry,h,f,o,n),x.geometry=L(b),d.push(x)}}else for(g=0;g<y.length;g++){var w,T,I=new E.GeometryInstance({geometry:V.PolygonGeometryLibrary.createGeometryFromPositions(o,y[g],r,n,t,u)});I.geometry.attributes.position.values=F.PolygonPipeline.scaleToGeodeticHeight(I.geometry.attributes.position.values,h,o,!n),b.geometry=I.geometry,I.geometry=L(b),z.defined(e._offsetAttribute)&&(w=I.geometry.attributes.position.values.length,w=new Uint8Array(w/3),T=e._offsetAttribute===Y.GeometryOffsetAttribute.NONE?0:1,Y.arrayFill(w,T),I.geometry.attributes.applyOffset=new Q.GeometryAttribute({componentDatatype:j.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:w})),d.push(I)}p=G.GeometryPipeline.combineInstances(d)[0],c=(p.attributes.position.values=new Float64Array(p.attributes.position.values),p.indices=O.IndexDatatype.createTypedArray(p.attributes.position.values.length/3,p.indices),p.attributes),i=U.BoundingSphere.fromVertices(c.position.values);return t.position||delete c.position,new Q.Geometry({attributes:c,indices:p.indices,primitiveType:p.primitiveType,boundingSphere:i,offsetAttribute:e._offsetAttribute})}}},b.createShadowVolume=function(e,t,o){var r=e._granularity,a=e._ellipsoid,t=t(r,a),o=o(r,a);return new b({polygonHierarchy:e._polygonHierarchy,ellipsoid:a,stRotation:e._stRotation,granularity:r,perPositionHeight:!1,extrudedHeight:t,height:o,vertexFormat:f.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(b.prototype,{rectangle:{get:function(){var e;return z.defined(this._rectangle)||(e=this._polygonHierarchy.positions,this._rectangle=i(e,this._ellipsoid,this._arcType,this._granularity)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){return z.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0==t)return[0,0,0,1,1,0];var o=e._ellipsoid,r=e._polygonHierarchy.positions,e=e.rectangle;return Q.Geometry._textureCoordinateRotationPoints(r,t,o,e)}(this)),this._textureCoordinateRotationPoints}}}),function(e,t){return(e=z.defined(t)?b.unpack(e,t):e)._ellipsoid=W.Ellipsoid.clone(e._ellipsoid),b.createGeometry(e)}});
