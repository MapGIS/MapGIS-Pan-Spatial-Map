define(["./Cartesian2-38b35910","./AxisAlignedBoundingBox-d272def4","./Transforms-07a9fab5","./when-ae2e0b60","./Check-f996273c","./TerrainEncoding-9adc5a79","./Math-5bbcea10","./OrientedBoundingBox-771a38ca","./WebMercatorProjection-cf614542","./AttributeCompression-25f42564","./EllipsoidTangentPlane-19622103","./RuntimeError-ac2797b4","./createTaskProcessorWorker","./combine-276652d0","./ComponentDatatype-e44126e4","./WebGLConstants-35626ea2","./Plane-45ad3143","./IntersectionTests-f49c7cd3"],function($e,lt,et,tt,t,ft,at,ut,it,rt,ct,r,a,i,n,s,o,l){"use strict";var f,u,c,d,h,B,e,m,x,w,y,g=Object.freeze({NONE:0,LERC:1}),nt={},st=(nt.DEFAULT_STRUCTURE=Object.freeze({heightScale:1,heightOffset:0,elementsPerHeight:1,stride:1,elementMultiplier:256,isBigEndian:!1}),new $e.Cartesian3),dt=new et.Matrix4,ht=new $e.Cartesian3,mt=new $e.Cartesian3,ot=new $e.Cartesian2,gt=new $e.Cartesian3,pt=new et.Matrix4,xt=new et.Matrix4,p=(nt.computeVertices=function(e){for(var u,c,d,h,m,g=Math.cos,p=Math.sin,x=Math.sqrt,w=Math.atan,y=Math.exp,k=at.CesiumMath.PI_OVER_TWO,I=at.CesiumMath.toRadians,b=e.heightmap,t=e.width,a=e.height,U=e.skirtHeight,T=0<U,M=tt.defaultValue(e.octEncodedNormals,void 0),A=tt.defined(e.octEncodedNormals),i=tt.defaultValue(e.repeat,new $e.Cartesian2(1,1)),V=tt.defaultValue(e.isGeographic,!0),v=tt.defaultValue(e.ellipsoid,$e.Ellipsoid.WGS84),B=1/v.maximumRadius,r=$e.Rectangle.clone(e.nativeRectangle),D=$e.Rectangle.clone(e.rectangle),S=tt.defined(D)?(u=D.west,c=D.south,d=D.east,D.north):V?(u=I(r.west),c=I(r.south),d=I(r.east),I(r.north)):(u=r.west*B,c=k-2*w(y(-r.south*B)),d=r.east*B,k-2*w(y(-r.north*B))),C=e.relativeToCenter,P=tt.defined(C),C=P?C:$e.Cartesian3.ZERO,E=tt.defaultValue(e.includeWebMercatorT,!1),F=tt.defaultValue(e.exaggeration,1),N=tt.defaultValue(e.exaggerationRelativeHeight,0),z=1!==F,L=tt.defaultValue(e.aspectArrow,!1),e=tt.defaultValue(e.structure,nt.DEFAULT_STRUCTURE),O=tt.defaultValue(e.heightScale,nt.DEFAULT_STRUCTURE.heightScale),R=tt.defaultValue(e.heightOffset,nt.DEFAULT_STRUCTURE.heightOffset),H=tt.defaultValue(e.elementsPerHeight,nt.DEFAULT_STRUCTURE.elementsPerHeight),_=tt.defaultValue(e.stride,nt.DEFAULT_STRUCTURE.stride),Y=tt.defaultValue(e.elementMultiplier,nt.DEFAULT_STRUCTURE.elementMultiplier),W=tt.defaultValue(e.isBigEndian,nt.DEFAULT_STRUCTURE.isBigEndian),X=$e.Rectangle.computeWidth(r),Z=$e.Rectangle.computeHeight(r),j=X/(t-1),G=Z/(a-1),e=(V||(X*=B,Z*=B),v.radiiSquared),q=e.x,Q=e.y,J=e.z,K=65536,$=-65536,e=et.Transforms.eastNorthUpToFixedFrame(C,v),ee=et.Matrix4.inverseTransformation(e,dt),te=(E&&(h=it.WebMercatorProjection.geodeticLatitudeToMercatorAngle(c),m=1/(it.WebMercatorProjection.geodeticLatitudeToMercatorAngle(S)-h)),ht),ae=(te.x=Number.POSITIVE_INFINITY,te.y=Number.POSITIVE_INFINITY,te.z=Number.POSITIVE_INFINITY,mt),ie=(ae.x=Number.NEGATIVE_INFINITY,ae.y=Number.NEGATIVE_INFINITY,ae.z=Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY),re=t*a,ne=re+(0<U?2*t+2*a:0),se=new Array(ne),oe=new Array(ne),le=new Array(ne),fe=E?new Array(ne):[],ue=z?new Array(ne):[],ce=0,de=a,he=0,me=t,ge=(T&&(--ce,++de,--he,++me),ce);ge<de;++ge){var pe,xe=ge,we=(a<=(xe=xe<0?0:xe)&&(xe=a-1),r.north-G*xe),we=V?I(we):k-2*w(y(-we*B)),ye=at.CesiumMath.clamp((we-c)/(S-c),0,1),ke=ge===ce,Ie=ge===de-1,be=(0<U&&(ke?we+=1e-5*Z:Ie&&(we-=1e-5*Z)),g(we)),Ue=p(we),Te=J*Ue;E&&(pe=(it.WebMercatorProjection.geodeticLatitudeToMercatorAngle(we)-h)*m);for(var Me=he;Me<me;++Me){var n=Me,Ae=xe*(t*_)+(n=t<=(n=n<0?0:n)?t-1:n)*_;if(1===H)s=b[Ae];else{var Ve,s=0;if(W)for(Ve=0;Ve<H;++Ve)s=s*Y+b[Ae+Ve];else for(Ve=H-1;0<=Ve;--Ve)s=s*Y+b[Ae+Ve]}s=s*O+R;var $=Math.max($,s),K=Math.min(K,s),o=r.west+j*n,ve=(V?o=I(o):o*=B,(o-u)/(d-u)),ve=at.CesiumMath.clamp(ve,0,1),Be=xe*t+n;if(0<U){var De=Me===he,Se=Me===me-1,Ce=ke||Ie||De||Se;if((ke||Ie)&&(De||Se))continue;Ce&&(s-=U,De?(Be=a-xe-1+re,o-=1e-5*X):Ie?Be=re+a+(t-n-1):Se?(Be=re+a+t+xe,o+=1e-5*X):ke&&(Be=re+a+t+a+n))}var Ce=be*g(o),De=be*p(o),Se=q*Ce,n=Q*De,o=1/x(Se*Ce+n*De+Te*Ue),Pe=Se*o,n=n*o,o=Te*o,Ee=new $e.Cartesian3;Ee.x=Pe+Ce*s,Ee.y=n+De*s,Ee.z=o+Ue*s,et.Matrix4.multiplyByPoint(ee,Ee,st),$e.Cartesian3.minimumByComponent(st,te,te),$e.Cartesian3.maximumByComponent(st,ae,ae),ie=Math.min(ie,s),se[Be]=Ee,le[Be]=new $e.Cartesian2(ve,ye),oe[Be]=s,E&&(fe[Be]=pe),z&&(ue[Be]=v.geodeticSurfaceNormal(Ee))}}for(var Fe,Ne,T=et.BoundingSphere.fromPoints(se),D=(tt.defined(D)&&(Fe=ut.OrientedBoundingBox.fromRectangle(D,K,$,v)),P&&(Ne=new ft.EllipsoidalOccluder(v).computeHorizonCullingPointPossiblyUnderEllipsoid(C,se,K)),new lt.AxisAlignedBoundingBox(te,ae,C)),ze=new ft.TerrainEncoding(C,D,ie,$,e,A,E,z,F,N),Le=new Float32Array(ne*ze.stride),Oe=0,Re=[],He=0;He<i.x*i.y;He++){var _e=new $e.Cartesian3;Re.push(_e)}for(var l=0;l<ne;++l)var f,Ye,We,Oe=A?(l<re&&(ot.x=M[We=2*l],ot.y=M[1+We],L&&(We=le[l].y,f=le[l].x,f=Math.floor(f*i.x),We=Math.floor(We*i.y),Ye=new $e.Cartesian3,rt.AttributeCompression.octDecode(ot.x,ot.y,Ye),(We=parseInt(We*i.x+f))<i.x*i.y&&$e.Cartesian3.add(Ye,Re[We],Re[We])),1!==F&&(f=rt.AttributeCompression.AttributeCompression.octDecode(ot.x,ot.y,gt),Ye=et.Transforms.Transforms.eastNorthUpToFixedFrame(se[l],v,xt),We=et.Transforms.Matrix4.inverseTransformation(Ye,pt),et.Transforms.Matrix4.multiplyByPointAsVector(We,f,f),f.z*=F,$e.Cartesian3.normalize(f,f),et.Transforms.Matrix4.multiplyByPointAsVector(Ye,f,f),$e.Cartesian3.normalize(f,f),rt.AttributeCompression.AttributeCompression.octEncode(f,ot))),ze.encode(Le,Oe,se[l],le[l],oe[l],ot,fe[l],ue[l])):ze.encode(Le,Oe,se[l],le[l],oe[l],void 0,fe[l],ue[l]);var Xe=[];if(A&&L)for(var Ze=0;Ze<i.y;Ze++)for(var je=0;je<i.x;je++){var Ge,qe,Qe,Je,Ke=Re[parseInt(Ze*i.x+je)];$e.Cartesian3.magnitude(Ke)<1e-10?Xe.push(0):($e.Cartesian3.normalize(Ke,Ke),Ge=new $e.Cartesian3,qe=parseInt(ne/2),qe=new ct.EllipsoidTangentPlane(se[qe]),Je=($e.Cartesian3.cross(qe.xAxis,qe.yAxis,Ge),$e.Cartesian3.normalize(Ge,Ge),new $e.Cartesian3),Qe=$e.Cartesian3.dot(Ke,Ge),Qe=($e.Cartesian3.multiplyByScalar(Ge,Qe,Je),new $e.Cartesian3),Ke=($e.Cartesian3.subtract(Ke,Je,Qe),$e.Cartesian3.angleBetween(Qe,qe.xAxis)),Je=new $e.Cartesian3,$e.Cartesian3.cross(qe.xAxis,Qe,Je),$e.Cartesian3.dot(Je,Ge)<0&&(Ke=2*Math.PI-Ke),Xe.push(Ke))}return{vertices:Le,maximumHeight:$,minimumHeight:K,encoding:ze,boundingSphere3D:T,orientedBoundingBox:Fe,occludeePointInScaledSpace:Ne,aspect:Xe,repeat:i}},{}),k=(u=function(e,u,t,c,d){for(var a,i,r,n,s,h=0,m=e.pixels.numBlocksX,g=e.pixels.numBlocksY,p=Math.floor(e.width/m),x=Math.floor(e.height/g),w=2*e.maxZError,o=Number.MAX_VALUE,y=(t=t||(e.mask?e.mask.bitset:null),i=new u(e.width*e.height),d&&t&&(r=new Uint8Array(e.width*e.height)),new Float32Array(p*x)),k=0;k<=g;k++){var I=k!==g?x:e.height%g;if(0!==I)for(var b=0;b<=m;b++){var U=b!==m?p:e.width%m;if(0!==U){var T,M,A,V,l=k*e.width*x+b*p,v=e.width-U,f=e.pixels.blocks[h];if(f.encoding<2?(T=0===f.encoding?f.rawData:(B(f.stuffedData,f.bitsPerPixel,f.numValidPixels,f.offset,w,y,e.pixels.maxValue),y),M=0):A=2===f.encoding?0:f.offset,t)for(s=0;s<I;s++){for(7&l&&(V=t[l>>3],V<<=7&l),n=0;n<U;n++)128&(V=7&l?V:t[l>>3])?(r&&(r[l]=1),o=(a=f.encoding<2?T[M++]:A)<o?a:o,i[l++]=a):(r&&(r[l]=0),i[l++]=c),V<<=1;l+=v}else if(f.encoding<2)for(s=0;s<I;s++){for(n=0;n<U;n++)o=(a=T[M++])<o?a:o,i[l++]=a;l+=v}else for(o=A<o?A:o,s=0;s<I;s++){for(n=0;n<U;n++)i[l++]=A;l+=v}if(1===f.encoding&&M!==f.numValidPixels)throw"Block and Mask do not match";h++}}}return{resultPixels:i,resultMask:r,minValue:o}},c=function(e){return{fileIdentifierString:e.fileIdentifierString,fileVersion:e.fileVersion,imageType:e.imageType,height:e.height,width:e.width,maxZError:e.maxZError,eofOffset:e.eofOffset,mask:e.mask?{numBlocksX:e.mask.numBlocksX,numBlocksY:e.mask.numBlocksY,numBytes:e.mask.numBytes,maxValue:e.mask.maxValue}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,numBytes:e.pixels.numBytes,maxValue:e.pixels.maxValue,noDataValue:e.noDataValue}}},d=function(e){for(var t=e.pixels.numBlocksX*e.pixels.numBlocksY,a={},i=0;i<t;i++){var r=e.pixels.blocks[i];0===r.encoding?a.float32=!0:1===r.encoding?a[r.bitsPerPixel]=!0:a[0]=!0}return Object.keys(a)},h=function(e,t,u){var a={},c=new Uint8Array(e,t,10);if(a.fileIdentifierString=String.fromCharCode.apply(null,c),"CntZImage"!==a.fileIdentifierString.trim())throw"Unexpected file identifier string: "+a.fileIdentifierString;t+=10;var i=new DataView(e,t,24);if(a.fileVersion=i.getInt32(0,!0),a.imageType=i.getInt32(4,!0),a.height=i.getUint32(8,!0),a.width=i.getUint32(12,!0),a.maxZError=i.getFloat64(16,!0),t+=24,!u)if(i=new DataView(e,t,16),a.mask={},a.mask.numBlocksY=i.getUint32(0,!0),a.mask.numBlocksX=i.getUint32(4,!0),a.mask.numBytes=i.getUint32(8,!0),a.mask.maxValue=i.getFloat32(12,!0),t+=16,0<a.mask.numBytes){var r=new Uint8Array(Math.ceil(a.width*a.height/8)),n=(i=new DataView(e,t,a.mask.numBytes)).getInt16(0,!0),d=2,h=0;do{if(0<n)for(;n--;)r[h++]=i.getUint8(d++);else for(var m=i.getUint8(d++),n=-n;n--;)r[h++]=m}while(n=i.getInt16(d,!0),(d+=2)<a.mask.numBytes);if(-32768!==n||h<r.length)throw"Unexpected end of mask RLE encoding";a.mask.bitset=r,t+=a.mask.numBytes}else 0==(a.mask.numBytes|a.mask.numBlocksY|a.mask.maxValue)&&(a.mask.bitset=new Uint8Array(Math.ceil(a.width*a.height/8)));i=new DataView(e,t,16),a.pixels={},a.pixels.numBlocksY=i.getUint32(0,!0),a.pixels.numBlocksX=i.getUint32(4,!0),a.pixels.numBytes=i.getUint32(8,!0),a.pixels.maxValue=i.getFloat32(12,!0),t+=16;for(var c=a.pixels.numBlocksX,u=a.pixels.numBlocksY,g=c+(0<a.width%c?1:0),p=u+(0<a.height%u?1:0),x=(a.pixels.blocks=new Array(g*p),0),w=0;w<p;w++)for(var y=0;y<g;y++){var s,o=0,l=e.byteLength-t,l=(i=new DataView(e,t,Math.min(10,l)),{}),f=(a.pixels.blocks[x++]=l,i.getUint8(0));if(o++,l.encoding=63&f,3<l.encoding)throw"Invalid block encoding ("+l.encoding+")";if(2!==l.encoding){if(0!==f&&2!==f){if(f>>=6,2===(l.offsetType=f))l.offset=i.getInt8(1),o++;else if(1===f)l.offset=i.getInt16(1,!0),o+=2;else{if(0!==f)throw"Invalid block offset type";l.offset=i.getFloat32(1,!0),o+=4}if(1===l.encoding)if(f=i.getUint8(o),o++,l.bitsPerPixel=63&f,f>>=6,2===(l.numValidPixelsType=f))l.numValidPixels=i.getUint8(o),o++;else if(1===f)l.numValidPixels=i.getUint16(o,!0),o+=2;else{if(0!==f)throw"Invalid valid pixel count type";l.numValidPixels=i.getUint32(o,!0),o+=4}}if(t+=o,3!==l.encoding)if(0===l.encoding){var f=(a.pixels.numBytes-1)/4;if(f!==Math.floor(f))throw"uncompressed block has invalid length";s=new ArrayBuffer(4*f),new Uint8Array(s).set(new Uint8Array(e,t,4*f));var o=new Float32Array(s);l.rawData=o,t+=4*f}else 1===l.encoding&&(o=Math.ceil(l.numValidPixels*l.bitsPerPixel/8),f=Math.ceil(o/4),s=new ArrayBuffer(4*f),new Uint8Array(s).set(new Uint8Array(e,t,o)),l.stuffedData=new Uint32Array(s),t+=o)}else t++}return a.eofOffset=t,a},B=function(e,t,a,i,r,u,c){var n,d,s,o,l=(1<<t)-1,h=0,f=0,m=Math.ceil((c-i)/r),g=4*e.length-Math.ceil(t*a/8);for(e[e.length-1]<<=8*g,n=0;n<a;n++)0===f&&(o=e[h++],f=32),t<=f?(s=o>>>f-t&l,f-=t):(s=(o&l)<<(d=t-f)&l,s+=(o=e[h++])>>>(f=32-d)),u[n]=s<m?i+s*r:c;return u},x=f={defaultNoDataValue:-34027999387901484e22,decode:function(e,t){var a=(t=t||{}).encodedMaskData||null===t.encodedMaskData,e=h(e,t.inputOffset||0,a),a=null!==t.noDataValue?t.noDataValue:f.defaultNoDataValue,i=u(e,t.pixelType||Float32Array,t.encodedMaskData,a,t.returnMask),a={width:e.width,height:e.height,pixelData:i.resultPixels,minValue:i.minValue,maxValue:e.pixels.maxValue,noDataValue:a};return i.resultMask&&(a.maskData=i.resultMask),t.returnEncodedMask&&e.mask&&(a.encodedMaskData=e.mask.bitset||null),t.returnFileInfo&&(a.fileInfo=c(e),t.computeUsedBitDepths&&(a.fileInfo.bitDepths=d(e))),a}},w=function(){var k=function(e,u,t,a,c,d,h,m){var i,r,n,s,g,o=(1<<t)-1,l=0,f=0,p=4*e.length-Math.ceil(t*a/8);if(e[e.length-1]<<=8*p,c)for(i=0;i<a;i++)0===f&&(n=e[l++],f=32),t<=f?(r=n>>>f-t&o,f-=t):(r=(n&o)<<(s=t-f)&o,r+=(n=e[l++])>>>(f=32-s)),u[i]=c[r];else for(g=Math.ceil((m-d)/h),i=0;i<a;i++)0===f&&(n=e[l++],f=32),t<=f?(r=n>>>f-t&o,f-=t):(r=(n&o)<<(s=t-f)&o,r+=(n=e[l++])>>>(f=32-s)),u[i]=r<g?d+r*h:m},I=function(e,t,a,i,u,c){for(var d,r,n=(1<<t)-1,h=0,s=0,o=0,l=0,f=[],m=4*e.length-Math.ceil(t*a/8),g=(e[e.length-1]<<=8*m,Math.ceil((c-i)/u)),s=0;s<a;s++)0===o&&(r=e[h++],o=32),t<=o?(l=r>>>o-t&n,o-=t):(l=(r&n)<<(d=t-o)&n,l+=(r=e[h++])>>>(o=32-d)),f[s]=l<g?i+l*u:c;return f.unshift(i),f},b=function(e,u,t,c,d,h,m,g){var a,i,r,n=(1<<t)-1,s=0,o=0,l=0;if(d)for(f=0;f<c;f++)0===o&&(i=e[s++],o=32,l=0),t<=o?(a=i>>>l&n,o-=t,l+=t):(a=i>>>l&n,o=32-(r=t-o),a|=((i=e[s++])&(1<<r)-1)<<t-r,l=r),u[f]=d[a];else for(var p=Math.ceil((g-h)/m),f=0;f<c;f++)0===o&&(i=e[s++],o=32,l=0),t<=o?(a=i>>>l&n,o-=t,l+=t):(a=i>>>l&n,o=32-(r=t-o),a|=((i=e[s++])&(1<<r)-1)<<t-r,l=r),u[f]=a<p?h+a*m:g;return u},U=function(e,t,u,a,c,d){for(var i,r,h=(1<<t)-1,m=0,n=0,s=0,o=0,l=0,f=[],g=Math.ceil((d-a)/c),n=0;n<u;n++)0===s&&(r=e[m++],s=32,l=0),t<=s?(o=r>>>l&h,s-=t,l+=t):(o=r>>>l&h,s=32-(i=t-s),o|=((r=e[m++])&(1<<i)-1)<<t-i,l=i),f[n]=o<g?a+o*c:d;return f.unshift(a),f},T=function(e,t,a,i){var r,n,s,o,l=(1<<a)-1,u=0,f=0,c=4*e.length-Math.ceil(a*i/8);for(e[e.length-1]<<=8*c,r=0;r<i;r++)0===f&&(s=e[u++],f=32),a<=f?(n=s>>>f-a&l,f-=a):(n=(s&l)<<(o=a-f)&l,n+=(s=e[u++])>>>(f=32-o)),t[r]=n;return t},M=function(e,t,a,u){for(var i,r,n,s=(1<<a)-1,c=0,o=0,l=0,f=0;f<u;f++)0===o&&(r=e[c++],o=32,l=0),a<=o?(i=r>>>l&s,o-=a,l+=a):(i=r>>>l&s,o=32-(n=a-o),i|=((r=e[c++])&(1<<n)-1)<<a-n,l=n),t[f]=i;return t},N={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(e){for(var t=65535,a=65535,i=e.length,r=Math.floor(i/2),n=0;r;){var s=359<=r?359:r;for(r-=s;a+=t=(t+=e[n++]<<8)+e[n++],--s;);t=(65535&t)+(t>>>16),a=(65535&a)+(a>>>16)}return 1&i&&(a+=t+=e[n]<<8),((a=(65535&a)+(a>>>16))<<16|(t=(65535&t)+(t>>>16)))>>>0},readHeaderInfo:function(e,t){var a=t.ptr,i=new Uint8Array(e,a,6),r={};if(r.fileIdentifierString=String.fromCharCode.apply(null,i),0!==r.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+r.fileIdentifierString;a+=6;var i=new DataView(e,a,8),n=i.getInt32(0,!0);if(a+=4,3<=(r.fileVersion=n)&&(r.checksum=i.getUint32(4,!0),a+=4),i=new DataView(e,a,12),r.height=i.getUint32(0,!0),r.width=i.getUint32(4,!0),a+=8,4<=n?(r.numDims=i.getUint32(8,!0),a+=4):r.numDims=1,i=new DataView(e,a,40),r.numValidPixel=i.getUint32(0,!0),r.microBlockSize=i.getInt32(4,!0),r.blobSize=i.getInt32(8,!0),r.imageType=i.getInt32(12,!0),r.maxZError=i.getFloat64(16,!0),r.zMin=i.getFloat64(24,!0),r.zMax=i.getFloat64(32,!0),a+=40,t.headerInfo=r,t.ptr=a,3<=n&&this.computeChecksumFletcher32(new Uint8Array(e,a-(4<=n?52:48),r.blobSize-14))!==r.checksum)throw"Checksum failed.";return!0},checkMinMaxRanges:function(e,t){var a=t.headerInfo,i=this.getDataTypeArray(a.imageType),r=a.numDims*this.getDataTypeSize(a.imageType),n=this.readSubArray(e,t.ptr,i,r),s=this.readSubArray(e,t.ptr+r,i,r);t.ptr+=2*r;for(var o=!0,l=0;l<a.numDims;l++)if(n[l]!==s[l]){o=!1;break}return a.minValues=n,a.maxValues=s,o},readSubArray:function(e,t,a,i){var r,e=a===Uint8Array?new Uint8Array(e,t,i):(r=new ArrayBuffer(i),new Uint8Array(r).set(new Uint8Array(e,t,i)),new a(r));return e},readMask:function(u,e){var t=e.ptr,a=e.headerInfo,i=a.width*a.height,a=a.numValidPixel,r=new DataView(u,t,4),n={};if(n.numBytes=r.getUint32(0,!0),t+=4,(0===a||i===a)&&0!==n.numBytes)throw"invalid mask";if(0===a)s=new Uint8Array(Math.ceil(i/8)),n.bitset=s,h=new Uint8Array(i),e.pixels.resultMask=h,t+=n.numBytes;else if(0<n.numBytes){var c,s=new Uint8Array(Math.ceil(i/8)),o=(r=new DataView(u,t,n.numBytes)).getInt16(0,!0),l=2,d=0;do{if(0<o)for(;o--;)s[d++]=r.getUint8(l++);else for(c=r.getUint8(l++),o=-o;o--;)s[d++]=c}while(o=r.getInt16(l,!0),(l+=2)<n.numBytes);if(-32768!==o||d<s.length)throw"Unexpected end of mask RLE encoding";for(var h=new Uint8Array(i),m=0,f=0,f=0;f<i;f++)7&f?(m=s[f>>3],m<<=7&f):m=s[f>>3],128&m&&(h[f]=1);e.pixels.resultMask=h,n.bitset=s,t+=n.numBytes}return e.ptr=t,e.mask=n,!0},readDataOneSweep:function(u,e,t){var a=e.ptr,i=e.headerInfo,r=i.numDims,n=i.width*i.height,s=i.imageType,i=i.numValidPixel*N.getDataTypeSize(s)*r,c=e.pixels.resultMask,o=t===Uint8Array?new Uint8Array(u,a,i):(s=new ArrayBuffer(i),new Uint8Array(s).set(new Uint8Array(u,a,i)),new t(s));if(o.length===n*r)e.pixels.resultPixels=o;else{e.pixels.resultPixels=new t(n*r);var d,h=0,l=0,f=0;if(1<r)for(f=0;f<r;f++)for(d=f*n,l=0;l<n;l++)c[l]&&(e.pixels.resultPixels[d+l]=o[h++]);else for(l=0;l<n;l++)c[l]&&(e.pixels.resultPixels[l]=o[h++])}return e.ptr=a+=i,!0},readHuffmanTree:function(u,c){var d=this.HUFFMAN_LUT_BITS_MAX,e=new DataView(u,c.ptr,16);if(c.ptr+=16,e.getInt32(0,!0)<2)throw"unsupported Huffman version";var t=e.getInt32(4,!0),a=e.getInt32(8,!0),h=e.getInt32(12,!0);if(h<=a)return!1;for(var i,m,r,g=new Uint32Array(h-a),n=(N.decodeBits(u,c,g),[]),s=a;s<h;s++)n[i=s-(s<t?0:t)]={first:g[s-a],second:null};var e=u.byteLength-c.ptr,p=Math.ceil(e/4),p=new ArrayBuffer(4*p),x=(new Uint8Array(p).set(new Uint8Array(u,c.ptr,e)),new Uint32Array(p)),o=0,w=0,y=x[0];for(s=a;s<h;s++)0<(r=n[i=s-(s<t?0:t)].first)&&(n[i].second=y<<o>>>32-r,r<=32-o?32===(o+=r)&&(o=0,y=x[++w]):(y=x[++w],n[i].second|=y>>>32-(o+=r-32)));var l=0,k=0,I=new V;for(s=0;s<n.length;s++)void 0!==n[s]&&(l=Math.max(l,n[s].first));k=d<=l?d:l,30<=l&&console.log("WARning, large NUM LUT BITS IS "+l);var b,U,T,M,f,A=[];for(s=a;s<h;s++)if(0<(r=n[i=s-(s<t?0:t)].first))if(b=[r,i],r<=k)for(U=n[i].second<<k-r,T=1<<k-r,m=0;m<T;m++)A[U|m]=b;else for(U=n[i].second,f=I,M=r-1;0<=M;M--)f=U>>>M&1?(f.right||(f.right=new V),f.right):(f.left||(f.left=new V),f.left),0!==M||f.val||(f.val=b[1]);return{decodeLut:A,numBitsLUTQick:k,numBitsLUT:l,tree:I,stuffedData:x,srcPtr:w,bitPos:o}},readHuffman:function(u,e,c){for(var t,d,a,i,r,h,m,n,s,g=e.headerInfo,p=g.numDims,x=e.headerInfo.height,w=e.headerInfo.width,y=w*x,u=this.readHuffmanTree(u,e),k=u.decodeLut,I=u.tree,b=u.stuffedData,o=u.srcPtr,l=u.bitPos,U=u.numBitsLUTQick,f=u.numBitsLUT,T=0===e.headerInfo.imageType?128:0,M=e.pixels.resultMask,A=0,V=(0<l&&(o++,l=0),b[o]),v=1===e.encodeMode,B=new c(y*p),D=B,S=0;S<g.numDims;S++){if(1<p&&(D=new c(B.buffer,y*S,y),A=0),e.headerInfo.numValidPixel===w*x)for(h=n=0;h<x;h++)for(m=0;m<w;m++,n++){if(d=0,r=i=V<<l>>>32-U,k[r=32-l<U?i|=b[o+1]>>>64-l-U:r])d=k[r][1],l+=k[r][0];else for(r=i=V<<l>>>32-f,32-l<f&&(r=i|=b[o+1]>>>64-l-f),t=I,s=0;s<f;s++)if(!(t=i>>>f-s-1&1?t.right:t.left).left&&!t.right){d=t.val,l=l+s+1;break}32<=l&&(l-=32,V=b[++o]),a=d-T,v?(a=a+(!(0<m)&&0<h?D[n-w]:A)&255,A=D[n]=a):D[n]=a}else for(h=n=0;h<x;h++)for(m=0;m<w;m++,n++)if(M[n]){if(d=0,r=i=V<<l>>>32-U,k[r=32-l<U?i|=b[o+1]>>>64-l-U:r])d=k[r][1],l+=k[r][0];else for(r=i=V<<l>>>32-f,32-l<f&&(r=i|=b[o+1]>>>64-l-f),t=I,s=0;s<f;s++)if(!(t=i>>>f-s-1&1?t.right:t.left).left&&!t.right){d=t.val,l=l+s+1;break}32<=l&&(l-=32,V=b[++o]),a=d-T,v?(!(0<m&&M[n-1])&&0<h&&M[n-w]?a+=D[n-w]:a+=A,a&=255,A=D[n]=a):D[n]=a}e.ptr=e.ptr+4*(o+1)+(0<l?4:0)}e.pixels.resultPixels=B},decodeBits:function(e,t,u,c,d){var a=t.headerInfo,h=a.fileVersion,i=0,m=5<=e.byteLength-t.ptr?5:e.byteLength-t.ptr,m=new DataView(e,t.ptr,m),g=m.getUint8(0),r=(i++,g>>6),r=0==r?4:3-r,p=0<(32&g),g=31&g,n=0;if(1==r)n=m.getUint8(i),i++;else if(2==r)n=m.getUint16(i,!0),i+=2;else{if(4!=r)throw"Invalid valid pixel count type";n=m.getUint32(i,!0),i+=4}var s,o,x,l,w,y,f,r=2*a.maxZError,d=1<a.numDims?a.maxValues[d]:a.zMax;if(p){for(t.counter.lut++,y=m.getUint8(i),i++,l=Math.ceil((y-1)*g/8),w=Math.ceil(l/4),o=new ArrayBuffer(4*w),x=new Uint8Array(o),t.ptr+=i,x.set(new Uint8Array(e,t.ptr,l)),a=new Uint32Array(o),t.ptr+=l,f=0;y-1>>>f;)f++;l=Math.ceil(n*f/8),w=Math.ceil(l/4),o=new ArrayBuffer(4*w),(x=new Uint8Array(o)).set(new Uint8Array(e,t.ptr,l)),s=new Uint32Array(o),t.ptr+=l,p=(3<=h?U:I)(a,g,y-1,c,r,d),(3<=h?b:k)(s,u,f,n,p)}else t.counter.bitstuffer++,f=g,t.ptr+=i,0<f&&(l=Math.ceil(n*f/8),w=Math.ceil(l/4),o=new ArrayBuffer(4*w),(x=new Uint8Array(o)).set(new Uint8Array(e,t.ptr,l)),s=new Uint32Array(o),t.ptr+=l,3<=h?null===c?M(s,u,f,n):b(s,u,f,n,!1,c,r,d):null===c?T(s,u,f,n):k(s,u,f,n,!1,c,r,d))},readTiles:function(u,e,c){for(var t,a,d,h,m,g,p,i,r,x,w,y=e.headerInfo,k=y.width,I=y.height,n=y.microBlockSize,b=y.imageType,U=N.getDataTypeSize(b),T=Math.ceil(k/n),M=Math.ceil(I/n),s=(e.pixels.numBlocksY=M,e.pixels.numBlocksX=T,e.pixels.ptr=0),o=0,A=0,V=0,l=0,v=0,B=0,f=0,D=new c(n*n),S=I%n||n,C=k%n||n,P=y.numDims,E=e.pixels.resultMask,F=e.pixels.resultPixels,A=0;A<M;A++)for(t=A!==M-1?n:S,V=0;V<T;V++)for(l=A*k*n+V*n,h=k-(a=V!==T-1?n:C),w=0;w<P;w++){if(1<P&&(F=new c(e.pixels.resultPixels.buffer,k*I*w*U,k*I)),m=u.byteLength-e.ptr,g={},f=0,f++,d=(i=(m=new DataView(u,e.ptr,Math.min(10,m))).getUint8(0))>>6&255,(i>>2&15)!=(V*n>>3&15))throw"integrity issue";if(3<(i=3&i))throw e.ptr+=f,"Invalid block encoding ("+i+")";if(2!=i)if(0==i){if(e.counter.uncompressed++,e.ptr+=f,v=(v=t*a*U)<(r=u.byteLength-e.ptr)?v:r,r=new ArrayBuffer(v%U==0?v:v+U-v%U),new Uint8Array(r).set(new Uint8Array(u,e.ptr,v)),p=new c(r),B=0,E)for(s=0;s<t;s++){for(o=0;o<a;o++)E[l]&&(F[l]=p[B++]),l++;l+=h}else for(s=0;s<t;s++){for(o=0;o<a;o++)F[l++]=p[B++];l+=h}e.ptr+=B*U}else if(r=N.getDataTypeUsed(b,d),x=N.getOnePixel(g,f,r,m),f+=N.getDataTypeSize(r),3==i)if(e.ptr+=f,e.counter.constantoffset++,E)for(s=0;s<t;s++){for(o=0;o<a;o++)E[l]&&(F[l]=x),l++;l+=h}else for(s=0;s<t;s++){for(o=0;o<a;o++)F[l++]=x;l+=h}else if(e.ptr+=f,N.decodeBits(u,e,D,x,w),f=0,E)for(s=0;s<t;s++){for(o=0;o<a;o++)E[l]&&(F[l]=D[f++]),l++;l+=h}else for(s=0;s<t;s++){for(o=0;o<a;o++)F[l++]=D[f++];l+=h}else e.counter.constant++,e.ptr+=f}},formatFileInfo:function(e){return{fileIdentifierString:e.headerInfo.fileIdentifierString,fileVersion:e.headerInfo.fileVersion,imageType:e.headerInfo.imageType,height:e.headerInfo.height,width:e.headerInfo.width,numValidPixel:e.headerInfo.numValidPixel,microBlockSize:e.headerInfo.microBlockSize,blobSize:e.headerInfo.blobSize,maxZError:e.headerInfo.maxZError,pixelType:N.getPixelType(e.headerInfo.imageType),eofOffset:e.eofOffset,mask:e.mask?{numBytes:e.mask.numBytes}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,maxValue:e.headerInfo.zMax,minValue:e.headerInfo.zMin,noDataValue:e.noDataValue}}},constructConstantSurface:function(e){var t,a=e.headerInfo.zMax,i=e.headerInfo.numDims,r=e.headerInfo.height*e.headerInfo.width,n=r*i,s=0,o=0,l=e.pixels.resultMask;if(l)if(1<i)for(s=0;s<i;s++)for(t=s*r,o=0;o<r;o++)l[o]&&(e.pixels.resultPixels[t+o]=a);else for(o=0;o<r;o++)l[o]&&(e.pixels.resultPixels[o]=a);else if(e.pixels.resultPixels.fill)e.pixels.resultPixels.fill(a);else for(o=0;o<n;o++)e.pixels.resultPixels[o]=a},getDataTypeArray:function(e){var t;switch(e){case 0:t=Int8Array;break;case 1:t=Uint8Array;break;case 2:t=Int16Array;break;case 3:t=Uint16Array;break;case 4:t=Int32Array;break;case 5:t=Uint32Array;break;case 6:t=Float32Array;break;case 7:t=Float64Array;break;default:t=Float32Array}return t},getPixelType:function(e){var t;switch(e){case 0:t="S8";break;case 1:t="U8";break;case 2:t="S16";break;case 3:t="U16";break;case 4:t="S32";break;case 5:t="U32";break;case 6:t="F32";break;case 7:t="F64";break;default:t="F32"}return t},isValidPixelValue:function(e,t){if(null===t)return!1;var a;switch(e){case 0:a=-128<=t&&t<=127;break;case 1:a=0<=t&&t<=255;break;case 2:a=-32768<=t&&t<=32767;break;case 3:a=0<=t&&t<=65536;break;case 4:a=-2147483648<=t&&t<=2147483647;break;case 5:a=0<=t&&t<=4294967296;break;case 6:a=-34027999387901484e22<=t&&t<=34027999387901484e22;break;case 7:a=5e-324<=t&&t<=17976931348623157e292;break;default:a=!1}return a},getDataTypeSize:function(e){var t=0;switch(e){case 0:case 1:t=1;break;case 2:case 3:t=2;break;case 4:case 5:case 6:t=4;break;case 7:t=8;break;default:t=e}return t},getDataTypeUsed:function(e,t){var a=e;switch(e){case 2:case 4:a=e-t;break;case 3:case 5:a=e-2*t;break;case 6:a=0===t?e:1===t?2:1;break;case 7:a=0===t?e:e-2*t+1;break;default:a=e}return a},getOnePixel:function(e,t,a,i){var r=0;switch(a){case 0:r=i.getInt8(t);break;case 1:r=i.getUint8(t);break;case 2:r=i.getInt16(t,!0);break;case 3:r=i.getUint16(t,!0);break;case 4:r=i.getInt32(t,!0);break;case 5:r=i.getUInt32(t,!0);break;case 6:r=i.getFloat32(t,!0);break;case 7:r=i.getFloat64(t,!0);break;default:throw"the decoder does not understand this pixel type"}return r}},V=function(e,t,a){this.val=e,this.left=t,this.right=a};return{decode:function(e,t){var a,i=(t=t||{}).noDataValue,r=0,n={},s=(n.ptr=t.inputOffset||0,n.pixels={},N.readHeaderInfo(e,n),n.headerInfo),u=s.fileVersion,o=N.getDataTypeArray(s.imageType),c=(N.readMask(e,n),s.numValidPixel===s.width*s.height||n.pixels.resultMask||(n.pixels.resultMask=t.maskData),s.width*s.height);if(n.pixels.resultPixels=new o(c*s.numDims),n.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0},0!==s.numValidPixel)if(s.zMax===s.zMin)N.constructConstantSurface(n);else if(4<=u&&N.checkMinMaxRanges(e,n))N.constructConstantSurface(n);else{var d=new DataView(e,n.ptr,2),l=d.getUint8(0);if(n.ptr++,l)N.readDataOneSweep(e,n,o);else if(1<u&&s.imageType<=1&&Math.abs(s.maxZError-.5)<1e-5){l=d.getUint8(1);if(n.ptr++,2<(n.encodeMode=l)||u<4&&1<l)throw"Invalid Huffman flag "+l;l?N.readHuffman(e,n,o):N.readTiles(e,n,o)}else N.readTiles(e,n,o)}n.eofOffset=n.ptr,t.inputOffset?(a=n.headerInfo.blobSize+t.inputOffset-n.ptr,1<=Math.abs(a)&&(n.eofOffset=t.inputOffset+n.headerInfo.blobSize)):(a=n.headerInfo.blobSize-n.ptr,1<=Math.abs(a)&&(n.eofOffset=n.headerInfo.blobSize));var f={width:s.width,height:s.height,pixelData:n.pixels.resultPixels,minValue:s.zMin,maxValue:s.zMax,validPixelCount:s.numValidPixel,dimCount:s.numDims,dimStats:{minValues:s.minValues,maxValues:s.maxValues},maskData:n.pixels.resultMask};if(n.pixels.resultMask&&N.isValidPixelValue(s.imageType,i)){for(var h=n.pixels.resultMask,r=0;r<c;r++)h[r]||(f.pixelData[r]=i);f.noDataValue=i}return n.noDataValue=i,t.returnFileInfo&&(f.fileInfo=N.formatFileInfo(n)),f},getBandCount:function(e){for(var t=0,a=0,i={ptr:0,pixels:{}};a<e.byteLength-58;)N.readHeaderInfo(e,i),a+=i.headerInfo.blobSize,t++,i.ptr=a;return t}}}(),e=new ArrayBuffer(4),m=new Uint8Array(e),y=(new Uint32Array(e)[0]=1)===m[0],p.Lerc={decode:function(u,e){if(!y)throw"Big endian system is not supported.";var c,t,d=(e=e||{}).inputOffset||0,a=new Uint8Array(u,d,10),a=String.fromCharCode.apply(null,a);if("CntZImage"===a.trim())c=x,t=1;else{if("Lerc2"!==a.substring(0,5))throw"Unexpected file identifier string: "+a;c=w,t=2}for(var h,m,i,r,n,g,s=0,p=u.byteLength-10,o=[],l={width:0,height:0,pixels:[],pixelType:e.pixelType,mask:null,statistics:[]};d<p;){var f=c.decode(u,{inputOffset:d,encodedMaskData:h,maskData:i,returnMask:0===s,returnEncodedMask:0===s,returnFileInfo:!0,pixelType:e.pixelType||null,noDataValue:e.noDataValue||null}),d=f.fileInfo.eofOffset;0===s&&(h=f.encodedMaskData,i=f.maskData,l.width=f.width,l.height=f.height,l.dimCount=f.dimCount||1,l.pixelType=f.pixelType||f.fileInfo.pixelType,l.mask=f.maskData),1<t&&f.fileInfo.mask&&0<f.fileInfo.mask.numBytes&&o.push(f.maskData),s++,l.pixels.push(f.pixelData),l.statistics.push({minValue:f.minValue,maxValue:f.maxValue,noDataValue:f.noDataValue,dimStats:f.dimStats})}if(1<t&&1<o.length){for(g=l.width*l.height,l.bandMasks=o,(i=new Uint8Array(g)).set(o[0]),r=1;r<o.length;r++)for(m=o[r],n=0;n<g;n++)i[n]=i[n]&m[n];l.maskData=i}return l}},p.Lerc);return a(function(e,t){if(e.encoding===g.LERC){try{a=k.decode(e.heightmap)}catch(e){throw new r.RuntimeError(e)}if(a.statistics[0].minValue===Number.MAX_VALUE)throw new r.RuntimeError("Invalid tile data");e.heightmap=a.pixels[0],e.width=a.width,e.height=a.height}e.ellipsoid=$e.Ellipsoid.clone(e.ellipsoid),e.rectangle=$e.Rectangle.clone(e.rectangle);var a=nt.computeVertices(e),i=a.vertices;return t.push(i.buffer),{vertices:i.buffer,numberOfAttributes:a.encoding.stride,minimumHeight:a.minimumHeight,maximumHeight:a.maximumHeight,gridWidth:e.width,gridHeight:e.height,boundingSphere3D:a.boundingSphere3D,orientedBoundingBox:a.orientedBoundingBox,occludeePointInScaledSpace:a.occludeePointInScaledSpace,encoding:a.encoding,westIndicesSouthToNorth:a.westIndicesSouthToNorth,southIndicesEastToWest:a.southIndicesEastToWest,eastIndicesNorthToSouth:a.eastIndicesNorthToSouth,northIndicesWestToEast:a.northIndicesWestToEast,aspect:a.aspect,repeat:a.repeat}})});
