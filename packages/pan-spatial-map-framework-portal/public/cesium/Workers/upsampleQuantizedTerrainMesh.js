define(["./AttributeCompression-25f42564","./Transforms-07a9fab5","./Cartesian2-38b35910","./when-ae2e0b60","./TerrainEncoding-9adc5a79","./IndexDatatype-516320ea","./Check-f996273c","./Math-5bbcea10","./OrientedBoundingBox-771a38ca","./createTaskProcessorWorker","./combine-276652d0","./RuntimeError-ac2797b4","./ComponentDatatype-e44126e4","./WebGLConstants-35626ea2","./EllipsoidTangentPlane-19622103","./AxisAlignedBoundingBox-d272def4","./IntersectionTests-f49c7cd3","./Plane-45ad3143"],function(s,ge,oe,g,me,xe,t,ae,we,i,n,r,h,u,o,a,p,d){"use strict";var Ce={clipTriangleAtAxisAlignedThreshold:function(e,t,i,n,s,r){g.defined(r)?r.length=0:r=[],t=t?(h=i<e,u=n<e,s<e):(h=e<i,u=e<n,e<s);var h,u,o,a,p,d,l,f,c=h+u+t;return 1===c?h?(o=(e-i)/(n-i),a=(e-i)/(s-i),r.push(1),r.push(2),1!==a&&(r.push(-1),r.push(0),r.push(2),r.push(a)),1!==o&&(r.push(-1),r.push(0),r.push(1),r.push(o))):u?(p=(e-n)/(s-n),d=(e-n)/(i-n),r.push(2),r.push(0),1!==d&&(r.push(-1),r.push(1),r.push(0),r.push(d)),1!==p&&(r.push(-1),r.push(1),r.push(2),r.push(p))):t&&(l=(e-s)/(i-s),f=(e-s)/(n-s),r.push(0),r.push(1),1!==f&&(r.push(-1),r.push(2),r.push(1),r.push(f)),1!==l&&(r.push(-1),r.push(2),r.push(0),r.push(l))):2===c?h||i===e?u||n===e?t||s===e||(a=(e-i)/(s-i),p=(e-n)/(s-n),r.push(2),r.push(-1),r.push(0),r.push(2),r.push(a),r.push(-1),r.push(1),r.push(2),r.push(p)):(f=(e-s)/(n-s),o=(e-i)/(n-i),r.push(1),r.push(-1),r.push(2),r.push(1),r.push(f),r.push(-1),r.push(0),r.push(1),r.push(o)):(d=(e-n)/(i-n),l=(e-s)/(i-s),r.push(0),r.push(-1),r.push(1),r.push(0),r.push(d),r.push(-1),r.push(2),r.push(0),r.push(l)):3!==c&&(r.push(0),r.push(1),r.push(2)),r},computeBarycentricCoordinates:function(e,t,i,n,s,r,h,u,o){var i=i-h,s=h-s,r=r-u,n=n-u,a=1/(r*i+s*n),t=t-u,u=e-h,e=(r*u+s*t)*a,h=(-n*u+i*t)*a,r=1-e-h;return g.defined(o)?(o.x=e,o.y=h,o.z=r,o):new oe.Cartesian3(e,h,r)},computeLineSegmentLineSegmentIntersection:function(e,t,i,n,s,r,h,u,o){var a=(h-s)*(t-r)-(u-r)*(e-s),p=(i-e)*(t-r)-(n-t)*(e-s),u=(u-r)*(i-e)-(h-s)*(n-t);if(0!=u)return r=a/u,h=p/u,0<=r&&r<=1&&0<=h&&h<=1?((o=g.defined(o)?o:new oe.Cartesian2).x=e+r*(i-e),o.y=t+r*(n-t),o):void 0}},pe=32767,de=16383,ve=[],Be=[],ye=[],le=new oe.Cartographic,fe=new oe.Cartesian3,Ie=[],Ae=[],be=[],Te=[],ze=[],Me=new oe.Cartesian3,Ne=new ge.BoundingSphere,Ve=new we.OrientedBoundingBox,Ee=new oe.Cartesian2,Re=new oe.Cartesian3;function ce(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}ce.prototype.clone=function(e){return(e=g.defined(e)?e:new ce).uBuffer=this.uBuffer,e.vBuffer=this.vBuffer,e.heightBuffer=this.heightBuffer,e.normalBuffer=this.normalBuffer,e.index=this.index,e.first=this.first,e.second=this.second,e.ratio=this.ratio,e},ce.prototype.initializeIndexed=function(e,t,i,n,s){this.uBuffer=e,this.vBuffer=t,this.heightBuffer=i,this.normalBuffer=n,this.index=s,this.first=void 0,this.second=void 0,this.ratio=void 0},ce.prototype.initializeFromClipResult=function(e,t,i){var n=t+1;return-1!==e[t]?i[e[t]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=i[e[n]],this.second=i[e[++n]],this.ratio=e[++n],++n),n},ce.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},ce.prototype.isIndexed=function(){return g.defined(this.index)},ce.prototype.getH=function(){return g.defined(this.index)?this.heightBuffer[this.index]:ae.CesiumMath.lerp(this.first.getH(),this.second.getH(),this.ratio)},ce.prototype.getU=function(){return g.defined(this.index)?this.uBuffer[this.index]:ae.CesiumMath.lerp(this.first.getU(),this.second.getU(),this.ratio)},ce.prototype.getV=function(){return g.defined(this.index)?this.vBuffer[this.index]:ae.CesiumMath.lerp(this.first.getV(),this.second.getV(),this.ratio)};var e=new oe.Cartesian2,l=-1,f=[new oe.Cartesian3,new oe.Cartesian3],c=[new oe.Cartesian3,new oe.Cartesian3];function x(e,t){var i=f[++l],n=c[l],i=s.AttributeCompression.octDecode(e.first.getNormalX(),e.first.getNormalY(),i),n=s.AttributeCompression.octDecode(e.second.getNormalX(),e.second.getNormalY(),n);return fe=oe.Cartesian3.lerp(i,n,e.ratio,fe),oe.Cartesian3.normalize(fe,fe),s.AttributeCompression.octEncode(fe,t),--l,t}ce.prototype.getNormalX=function(){return g.defined(this.index)?this.normalBuffer[2*this.index]:(e=x(this,e)).x},ce.prototype.getNormalY=function(){return g.defined(this.index)?this.normalBuffer[2*this.index+1]:(e=x(this,e)).y};var m=[];function He(e,p,d,t,i,n,s,l,f){if(0!==s.length){for(var r=0,h=0;h<s.length;)h=m[r++].initializeFromClipResult(s,h,l);for(var u=0;u<r;++u){var o,c,a=m[u];a.isIndexed()?(a.newIndex=n[a.index],a.uBuffer=e,a.vBuffer=p,a.heightBuffer=d,f&&(a.normalBuffer=t)):(o=a.getKey(),g.defined(n[o])?a.newIndex=n[o]:(c=e.length,e.push(a.getU()),p.push(a.getV()),d.push(a.getH()),f&&(t.push(a.getNormalX()),t.push(a.getNormalY())),a.newIndex=c,n[o]=c))}3===r?(i.push(m[0].newIndex),i.push(m[1].newIndex),i.push(m[2].newIndex)):4===r&&(i.push(m[0].newIndex),i.push(m[1].newIndex),i.push(m[2].newIndex),i.push(m[0].newIndex),i.push(m[2].newIndex),i.push(m[3].newIndex))}}return m.push(new ce),m.push(new ce),m.push(new ce),m.push(new ce),i(function(e,p){for(var d=e.isEastChild,l=e.isNorthChild,f=d?de:0,c=d?pe:de,g=l?de:0,m=l?pe:de,t=Ie,i=Ae,n=be,x=ze,w=(t.length=0,i.length=0,n.length=0,x.length=0,Te),C=(w.length=0,{}),v=e.vertices,B=(B=e.indices).subarray(0,e.indexCountWithoutSkirts),y=me.TerrainEncoding.clone(e.encoding),I=y.hasVertexNormals,A=0,b=e.vertexCountWithoutSkirts,T=e.minimumHeight,z=e.maximumHeight,M=new Array(b),N=new Array(b),V=new Array(b),E=I?new Array(2*b):void 0,s=0,R=0;s<b;++s,R+=2){var H=y.decodeTextureCoordinates(v,s,Ee),O=y.decodeHeight(v,s),r=ae.CesiumMath.clamp(H.x*pe|0,0,pe),h=ae.CesiumMath.clamp(H.y*pe|0,0,pe);V[s]=ae.CesiumMath.clamp((O-T)/(z-T)*pe|0,0,pe),pe-(r=r<20?0:r)<20&&(r=pe),pe-(h=h<20?0:h)<20&&(h=pe),M[s]=r,N[s]=h,I&&(H=y.getOctEncodedNormal(v,s,Re),E[R]=H.x,E[R+1]=H.y),(d&&de<=r||!d&&r<=de)&&(l&&de<=h||!l&&h<=de)&&(C[s]=A,t.push(r),i.push(h),n.push(V[s]),I&&(x.push(E[R]),x.push(E[R+1])),++A)}var u=[],o=(u.push(new ce),u.push(new ce),u.push(new ce),[]);for(o.push(new ce),o.push(new ce),o.push(new ce),s=0;s<B.length;s+=3){var S,a=B[s],U=B[s+1],F=B[s+2],P=M[a],k=M[U],D=M[F],a=(u[0].initializeIndexed(M,N,V,E,a),u[1].initializeIndexed(M,N,V,E,U),u[2].initializeIndexed(M,N,V,E,F),Ce.clipTriangleAtAxisAlignedThreshold(de,d,P,k,D,ve));a.length<=0||(S=o[0].initializeFromClipResult(a,0,u))>=a.length||(S=o[1].initializeFromClipResult(a,S,u))>=a.length||(S=o[2].initializeFromClipResult(a,S,u),He(t,i,n,x,w,C,Ce.clipTriangleAtAxisAlignedThreshold(de,l,o[0].getV(),o[1].getV(),o[2].getV(),Be),o,I),S<a.length&&(o[2].clone(o[1]),o[2].initializeFromClipResult(a,S,u),He(t,i,n,x,w,C,Ce.clipTriangleAtAxisAlignedThreshold(de,l,o[0].getV(),o[1].getV(),o[2].getV(),Be),o,I)))}var W=d?-pe:0,X=l?-pe:0,K=[],L=[],Y=[],_=[],G=Number.MAX_VALUE,J=-G,Z=ye,j=(Z.length=0,oe.Ellipsoid.clone(e.ellipsoid)),q=(e=oe.Rectangle.clone(e.childRectangle)).north,Q=e.south,$=e.east,ee=e.west;for($<ee&&($+=ae.CesiumMath.TWO_PI),s=0;s<t.length;++s)r=(r=Math.round(t[s]))<=f?(K.push(s),0):c<=r?(Y.push(s),pe):2*r+W,t[s]=r,h=(h=Math.round(i[s]))<=g?(L.push(s),0):m<=h?(_.push(s),pe):2*h+X,i[s]=h,(O=ae.CesiumMath.lerp(T,z,n[s]/pe))<G&&(G=O),J<O&&(J=O),n[s]=O,le.longitude=ae.CesiumMath.lerp(ee,$,r/pe),le.latitude=ae.CesiumMath.lerp(Q,q,h/pe),le.height=O,j.cartographicToCartesian(le,fe),Z.push(fe.x),Z.push(fe.y),Z.push(fe.z);var te=ge.BoundingSphere.fromVertices(Z,oe.Cartesian3.ZERO,3,Ne),e=we.OrientedBoundingBox.fromRectangle(e,G,J,j,Ve),ie=new me.EllipsoidalOccluder(j).computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid(te.center,Z,3,te.center,G,Me),ne=J-G,se=new Uint16Array(t.length+i.length+n.length);for(s=0;s<t.length;++s)se[s]=t[s];var re=t.length;for(s=0;s<i.length;++s)se[re+s]=i[s];for(re+=i.length,s=0;s<n.length;++s)se[re+s]=pe*(n[s]-G)/ne;var he,ue=xe.IndexDatatype.createTypedArray(t.length,w);return I?(he=new Uint8Array(x),p.push(se.buffer,ue.buffer,he.buffer),he=he.buffer):p.push(se.buffer,ue.buffer),{vertices:se.buffer,encodedNormals:he,indices:ue.buffer,minimumHeight:G,maximumHeight:J,westIndices:K,southIndices:L,eastIndices:Y,northIndices:_,boundingSphere:te,orientedBoundingBox:e,horizonOcclusionPoint:ie}})});
