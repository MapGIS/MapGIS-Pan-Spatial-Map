define(["./when-ae2e0b60","./Cartesian2-38b35910","./GeometryOffsetAttribute-b02d5bb9","./Transforms-f0fd44c2","./Check-f996273c","./ComponentDatatype-e44126e4","./GeometryAttribute-0e25489a","./GeometryAttributes-5ce4955a","./GeometryInstance-0498c71f","./GeometryPipeline-592f8e72","./IndexDatatype-516320ea","./Math-5bbcea10","./PolygonPipeline-0d0d24fa","./RectangleGeometryLibrary-ab511eb9","./VertexFormat-90d15264","./combine-276652d0","./RuntimeError-ac2797b4","./WebGLConstants-35626ea2","./AttributeCompression-25f42564","./EncodedCartesian3-d40e98d6","./IntersectionTests-8ca4dd3d","./Plane-9e1b50ea","./EllipsoidRhumbLine-af7b5ebe"],function(X,Q,W,S,t,J,j,r,Z,K,$,tt,et,I,at,e,a,n,i,o,s,l,u){"use strict";var rt=new Q.Cartesian3,nt=new Q.Cartesian3,it=new Q.Cartesian3,ot=new Q.Cartesian3,c=new Q.Rectangle,k=new Q.Cartesian2,m=new S.BoundingSphere,v=new S.BoundingSphere;function st(t,e){var a=new j.Geometry({attributes:new r.GeometryAttributes,primitiveType:j.PrimitiveType.TRIANGLES});return a.attributes.position=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:e.positions}),t.normal&&(a.attributes.normal=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:e.normals})),t.tangent&&(a.attributes.tangent=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:e.tangents})),t.bitangent&&(a.attributes.bitangent=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:e.bitangents})),a}var lt=new Q.Cartesian3,ut=new Q.Cartesian3;function ct(t,e){for(var a=t._vertexFormat,r=t._ellipsoid,t=e.height,n=e.width,i=e.northCap,o=e.southCap,s=0,l=t,u=t,c=0,m=(i&&(--u,c+=s=1),o&&(--l,--u,c+=1),c+=n*u,a.position?new Float64Array(3*c):void 0),p=a.st?new Float32Array(2*c):void 0,d=0,g=0,y=rt,f=k,h=Number.MAX_VALUE,b=Number.MAX_VALUE,_=-Number.MAX_VALUE,v=-Number.MAX_VALUE,A=s;A<l;++A)for(var x=0;x<n;++x)I.RectangleGeometryLibrary.computePosition(e,r,a.st,A,x,y,f),m[d++]=y.x,m[d++]=y.y,m[d++]=y.z,a.st&&(p[g++]=f.x,p[g++]=f.y,h=Math.min(h,f.x),b=Math.min(b,f.y),_=Math.max(_,f.x),v=Math.max(v,f.y));if(i&&(I.RectangleGeometryLibrary.computePosition(e,r,a.st,0,0,y,f),m[d++]=y.x,m[d++]=y.y,m[d++]=y.z,a.st&&(p[g++]=f.x,p[g++]=f.y,h=f.x,b=f.y,_=f.x,v=f.y)),o&&(I.RectangleGeometryLibrary.computePosition(e,r,a.st,t-1,0,y,f),m[d++]=y.x,m[d++]=y.y,m[d]=y.z,a.st&&(p[g++]=f.x,p[g]=f.y,h=Math.min(h,f.x),b=Math.min(b,f.y),_=Math.max(_,f.x),v=Math.max(v,f.y))),a.st&&(h<0||b<0||1<_||1<v))for(var w=0;w<p.length;w+=2)p[w]=(p[w]-h)/(_-h),p[w+1]=(p[w+1]-b)/(v-b);for(var s=function(t,e,a,r){var n=t.length,i=e.normal?new Float32Array(n):void 0,o=e.tangent?new Float32Array(n):void 0,s=e.bitangent?new Float32Array(n):void 0,l=0,u=ot,c=it,m=nt;if(e.normal||e.tangent||e.bitangent)for(var p=0;p<n;p+=3){var d=Q.Cartesian3.fromArray(t,p,rt),g=l+1,y=l+2,m=a.geodeticSurfaceNormal(d,m);(e.tangent||e.bitangent)&&(Q.Cartesian3.cross(Q.Cartesian3.UNIT_Z,m,c),S.Matrix3.multiplyByVector(r,c,c),Q.Cartesian3.normalize(c,c),e.bitangent&&Q.Cartesian3.normalize(Q.Cartesian3.cross(m,c,u),u)),e.normal&&(i[l]=m.x,i[g]=m.y,i[y]=m.z),e.tangent&&(o[l]=c.x,o[g]=c.y,o[y]=c.z),e.bitangent&&(s[l]=u.x,s[g]=u.y,s[y]=u.z),l+=3}return st(e,{positions:t,normals:i,tangents:o,bitangents:s})}(m,a,r,e.tangentRotationMatrix),t=6*(n-1)*(u-1),C=(i&&(t+=3*(n-1)),o&&(t+=3*(n-1)),$.IndexDatatype.createTypedArray(c,t)),R=0,E=0,F=0;F<u-1;++F){for(var G=0;G<n-1;++G){var P=R,V=P+n,L=V+1,D=P+1;C[E++]=P,C[E++]=V,C[E++]=D,C[E++]=D,C[E++]=V,C[E++]=L,++R}++R}if(i||o){var M,T,O=c-1,N=c-1;if(i&&o&&(O=c-2),R=0,i)for(F=0;F<n-1;F++)T=(M=R)+1,C[E++]=O,C[E++]=M,C[E++]=T,++R;if(o)for(R=(u-1)*n,F=0;F<n-1;F++)T=(M=R)+1,C[E++]=M,C[E++]=N,C[E++]=T,++R}return s.indices=C,a.st&&(s.attributes.st=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:p})),s}function mt(t,e,a,r,n){return t[e++]=r[a],t[e++]=r[a+1],t[e++]=r[a+2],t[e++]=n[a],t[e++]=n[a+1],t[e]=n[a+2],t}function pt(t,e,a,r){return t[e++]=r[a],t[e++]=r[a+1],t[e++]=r[a],t[e]=r[a+1],t}var dt=new at.VertexFormat;function A(t,e){var a,r,N,n=t._shadowVolume,i=t._offsetAttribute,o=t._vertexFormat,s=t._extrudedHeight,l=t._surfaceHeight,S=t._ellipsoid,u=e.height,c=e.width,m=(n&&((m=at.VertexFormat.clone(o,dt)).normal=!0,t._vertexFormat=m),ct(t,e)),p=(n&&(t._vertexFormat=o),et.PolygonPipeline.scaleToGeodeticHeight(m.attributes.position.values,l,S,!1)),t=2*(T=(p=new Float64Array(p)).length),l=new Float64Array(t),d=(l.set(p),et.PolygonPipeline.scaleToGeodeticHeight(m.attributes.position.values,s,S)),s=(l.set(d,T),m.attributes.position.values=l,o.normal?new Float32Array(t):void 0),l=o.tangent?new Float32Array(t):void 0,g=o.bitangent?new Float32Array(t):void 0,y=o.st?new Float32Array(t/3*2):void 0;if(o.normal){for(r=m.attributes.normal.values,s.set(r),f=0;f<T;f++)r[f]=-r[f];s.set(r,T),m.attributes.normal.values=s}if(n){r=m.attributes.normal.values,o.normal||(m.attributes.normal=void 0);for(var s=new Float32Array(t),f=0;f<T;f++)r[f]=-r[f];s.set(r,T),m.attributes.extrudeDirection=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:s})}s=X.defined(i);if(s&&(A=T/3*2,v=new Uint8Array(A),v=i===W.GeometryOffsetAttribute.TOP?W.arrayFill(v,1,0,A/2):(N=i===W.GeometryOffsetAttribute.NONE?0:1,W.arrayFill(v,N)),m.attributes.applyOffset=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:v})),o.tangent){var I=m.attributes.tangent.values;for(l.set(I),f=0;f<T;f++)I[f]=-I[f];l.set(I,T),m.attributes.tangent.values=l}o.bitangent&&(A=m.attributes.bitangent.values,g.set(A),g.set(A,T),m.attributes.bitangent.values=g),o.st&&(a=m.attributes.st.values,y.set(a),y.set(a,T/3*2),m.attributes.st.values=y);var h=m.indices,b=h.length,k=T/3,_=$.IndexDatatype.createTypedArray(t/3,2*b);for(_.set(h),f=0;f<b;f+=3)_[f+b]=h[f+2]+k,_[f+1+b]=h[f+1]+k,_[f+2+b]=h[f]+k;m.indices=_;var v=e.northCap,l=e.southCap,A=u,g=2,y=0,t=4,e=4,u=(v&&(--g,--A,y+=1,t-=2,--e),l&&(--g,--A,y+=1,t-=2,--e),2*((y+=g*c+2*A-t)+e)),x=new Float64Array(3*u),w=n?new Float32Array(3*u):void 0,C=s?new Uint8Array(u):void 0,R=o.st?new Float32Array(2*u):void 0,E=i===W.GeometryOffsetAttribute.TOP,F=(s&&!E&&(N=i===W.GeometryOffsetAttribute.ALL?1:0,C=W.arrayFill(C,N)),0),G=0,P=0,V=0,L=c*A;for(f=0;f<L;f+=c)x=mt(x,F,D=3*f,p,d),F+=6,o.st&&(R=pt(R,G,2*f,a),G+=4),n&&(P+=3,w[P++]=r[D],w[P++]=r[D+1],w[P++]=r[D+2]),E&&(C[V++]=1,V+=1);if(l){var H=v?1+L:L,D=3*H;for(f=0;f<2;f++)x=mt(x,F,D,p,d),F+=6,o.st&&(R=pt(R,G,2*H,a),G+=4),n&&(P+=3,w[P++]=r[D],w[P++]=r[D+1],w[P++]=r[D+2]),E&&(C[V++]=1,V+=1)}else for(f=L-c;f<L;f++)x=mt(x,F,D=3*f,p,d),F+=6,o.st&&(R=pt(R,G,2*f,a),G+=4),n&&(P+=3,w[P++]=r[D],w[P++]=r[D+1],w[P++]=r[D+2]),E&&(C[V++]=1,V+=1);for(f=L-1;0<f;f-=c)x=mt(x,F,D=3*f,p,d),F+=6,o.st&&(R=pt(R,G,2*f,a),G+=4),n&&(P+=3,w[P++]=r[D],w[P++]=r[D+1],w[P++]=r[D+2]),E&&(C[V++]=1,V+=1);if(v){var z=L;for(D=3*z,f=0;f<2;f++)x=mt(x,F,D,p,d),F+=6,o.st&&(R=pt(R,G,2*z,a),G+=4),n&&(P+=3,w[P++]=r[D],w[P++]=r[D+1],w[P++]=r[D+2]),E&&(C[V++]=1,V+=1)}else for(f=c-1;0<=f;f--)x=mt(x,F,D=3*f,p,d),F+=6,o.st&&(R=pt(R,G,2*f,a),G+=4),n&&(P+=3,w[P++]=r[D],w[P++]=r[D+1],w[P++]=r[D+2]),E&&(C[V++]=1,V+=1);var g=function(t,e,a){var r=t.length,n=e.normal?new Float32Array(r):void 0,i=e.tangent?new Float32Array(r):void 0,o=e.bitangent?new Float32Array(r):void 0,s=0,l=0,u=0,c=!0,m=ot,p=it,d=nt;if(e.normal||e.tangent||e.bitangent)for(var g=0;g<r;g+=6){var y,f=Q.Cartesian3.fromArray(t,g,rt),h=Q.Cartesian3.fromArray(t,(g+6)%r,lt);c&&(y=Q.Cartesian3.fromArray(t,(g+3)%r,ut),Q.Cartesian3.subtract(h,f,h),Q.Cartesian3.subtract(y,f,y),d=Q.Cartesian3.normalize(Q.Cartesian3.cross(y,h,d),d),c=!1),Q.Cartesian3.equalsEpsilon(h,f,tt.CesiumMath.EPSILON10)&&(c=!0),(e.tangent||e.bitangent)&&(m=a.geodeticSurfaceNormal(f,m),e.tangent&&(p=Q.Cartesian3.normalize(Q.Cartesian3.cross(m,d,p),p))),e.normal&&(n[s++]=d.x,n[s++]=d.y,n[s++]=d.z,n[s++]=d.x,n[s++]=d.y,n[s++]=d.z),e.tangent&&(i[l++]=p.x,i[l++]=p.y,i[l++]=p.z,i[l++]=p.x,i[l++]=p.y,i[l++]=p.z),e.bitangent&&(o[u++]=m.x,o[u++]=m.y,o[u++]=m.z,o[u++]=m.x,o[u++]=m.y,o[u++]=m.z)}return st(e,{positions:t,normals:n,tangents:i,bitangents:o})}(x,o,S),M=(o.st&&(g.attributes.st=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:R})),n&&(g.attributes.extrudeDirection=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:w})),s&&(g.attributes.applyOffset=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:C})),$.IndexDatatype.createTypedArray(u,6*y)),T=x.length/3,O=0;for(f=0;f<T-1;f+=2){var B,U=((B=f)+2)%T,Y=Q.Cartesian3.fromArray(x,3*B,lt),q=Q.Cartesian3.fromArray(x,3*U,ut);Q.Cartesian3.equalsEpsilon(Y,q,tt.CesiumMath.EPSILON10)||(q=(2+(Y=(B+1)%T))%T,M[O++]=B,M[O++]=Y,M[O++]=U,M[O++]=U,M[O++]=Y,M[O++]=q)}return g.indices=M,(g=K.GeometryPipeline.combineInstances([new Z.GeometryInstance({geometry:m}),new Z.GeometryInstance({geometry:g})]))[0]}var x=[new Q.Cartesian3,new Q.Cartesian3,new Q.Cartesian3,new Q.Cartesian3],p=new Q.Cartographic,w=new Q.Cartographic;function d(t,e,a,r,n){if(0===a)return Q.Rectangle.clone(t,n);var t=I.RectangleGeometryLibrary.computeOptions(t,e,a,0,c,p),e=t.height,a=t.width,i=x;return I.RectangleGeometryLibrary.computePosition(t,r,!1,0,0,i[0]),I.RectangleGeometryLibrary.computePosition(t,r,!1,0,a-1,i[1]),I.RectangleGeometryLibrary.computePosition(t,r,!1,e-1,0,i[2]),I.RectangleGeometryLibrary.computePosition(t,r,!1,e-1,a-1,i[3]),Q.Rectangle.fromCartesianArray(i,r,n)}function g(t){var e=(t=X.defaultValue(t,X.defaultValue.EMPTY_OBJECT)).rectangle,a=X.defaultValue(t.height,0),r=X.defaultValue(t.extrudedHeight,a);this._rectangle=Q.Rectangle.clone(e),this._granularity=X.defaultValue(t.granularity,tt.CesiumMath.RADIANS_PER_DEGREE),this._ellipsoid=Q.Ellipsoid.clone(X.defaultValue(t.ellipsoid,Q.Ellipsoid.WGS84)),this._surfaceHeight=Math.max(a,r),this._rotation=X.defaultValue(t.rotation,0),this._stRotation=X.defaultValue(t.stRotation,0),this._vertexFormat=at.VertexFormat.clone(X.defaultValue(t.vertexFormat,at.VertexFormat.DEFAULT)),this._extrudedHeight=Math.min(a,r),this._shadowVolume=X.defaultValue(t.shadowVolume,!1),this._workerName="createRectangleGeometry",this._offsetAttribute=t.offsetAttribute,this._rotatedRectangle=void 0,this._textureCoordinateRotationPoints=void 0}g.packedLength=Q.Rectangle.packedLength+Q.Ellipsoid.packedLength+at.VertexFormat.packedLength+7,g.pack=function(t,e,a){return a=X.defaultValue(a,0),Q.Rectangle.pack(t._rectangle,e,a),a+=Q.Rectangle.packedLength,Q.Ellipsoid.pack(t._ellipsoid,e,a),a+=Q.Ellipsoid.packedLength,at.VertexFormat.pack(t._vertexFormat,e,a),a+=at.VertexFormat.packedLength,e[a++]=t._granularity,e[a++]=t._surfaceHeight,e[a++]=t._rotation,e[a++]=t._stRotation,e[a++]=t._extrudedHeight,e[a++]=t._shadowVolume?1:0,e[a]=X.defaultValue(t._offsetAttribute,-1),e};var y=new Q.Rectangle,f=Q.Ellipsoid.clone(Q.Ellipsoid.UNIT_SPHERE),h={rectangle:y,ellipsoid:f,vertexFormat:dt,granularity:void 0,height:void 0,rotation:void 0,stRotation:void 0,extrudedHeight:void 0,shadowVolume:void 0,offsetAttribute:void 0},C=(g.unpack=function(t,e,a){e=X.defaultValue(e,0);var r=Q.Rectangle.unpack(t,e,y),n=(e+=Q.Rectangle.packedLength,Q.Ellipsoid.unpack(t,e,f)),i=(e+=Q.Ellipsoid.packedLength,at.VertexFormat.unpack(t,e,dt)),o=(e+=at.VertexFormat.packedLength,t[e++]),s=t[e++],l=t[e++],u=t[e++],c=t[e++],m=1===t[e++],t=t[e];return X.defined(a)?(a._rectangle=Q.Rectangle.clone(r,a._rectangle),a._ellipsoid=Q.Ellipsoid.clone(n,a._ellipsoid),a._vertexFormat=at.VertexFormat.clone(i,a._vertexFormat),a._granularity=o,a._surfaceHeight=s,a._rotation=l,a._stRotation=u,a._extrudedHeight=c,a._shadowVolume=m,a._offsetAttribute=-1===t?void 0:t,a):(h.granularity=o,h.height=s,h.rotation=l,h.stRotation=u,h.extrudedHeight=c,h.shadowVolume=m,h.offsetAttribute=-1===t?void 0:t,new g(h))},g.computeRectangle=function(t,e){var a=(t=X.defaultValue(t,X.defaultValue.EMPTY_OBJECT)).rectangle,r=X.defaultValue(t.granularity,tt.CesiumMath.RADIANS_PER_DEGREE),n=X.defaultValue(t.ellipsoid,Q.Ellipsoid.WGS84);return d(a,r,X.defaultValue(t.rotation,0),n,e)},new S.Matrix3),b=new S.Quaternion,R=new Q.Cartographic,_=(g.createGeometry=function(t){var e,a,r,n,i,o,s,l,u;if(!tt.CesiumMath.equalsEpsilon(t._rectangle.north,t._rectangle.south,tt.CesiumMath.EPSILON10)&&!tt.CesiumMath.equalsEpsilon(t._rectangle.east,t._rectangle.west,tt.CesiumMath.EPSILON10))return e=t._rectangle,a=t._ellipsoid,n=t._rotation,s=t._stRotation,r=t._vertexFormat,o=I.RectangleGeometryLibrary.computeOptions(e,t._granularity,n,s,c,p,w),l=C,0!==s||0!==n?(n=Q.Rectangle.center(e,R),n=a.geodeticSurfaceNormalCartographic(n,lt),S.Quaternion.fromAxisAngle(n,-s,b),S.Matrix3.fromQuaternion(b,l)):S.Matrix3.clone(S.Matrix3.IDENTITY,l),n=t._surfaceHeight,s=t._extrudedHeight,u=!tt.CesiumMath.equalsEpsilon(n,s,0,tt.CesiumMath.EPSILON2),o.lonScalar=1/t._rectangle.width,o.latScalar=1/t._rectangle.height,o.tangentRotationMatrix=l,e=t._rectangle,o=u?(i=A(t,o),l=S.BoundingSphere.fromRectangle3D(e,a,n,v),u=S.BoundingSphere.fromRectangle3D(e,a,s,m),S.BoundingSphere.union(l,u)):((i=ct(t,o)).attributes.position.values=et.PolygonPipeline.scaleToGeodeticHeight(i.attributes.position.values,n,a,!1),X.defined(t._offsetAttribute)&&(s=i.attributes.position.values.length,l=new Uint8Array(s/3),u=t._offsetAttribute===W.GeometryOffsetAttribute.NONE?0:1,W.arrayFill(l,u),i.attributes.applyOffset=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:l})),S.BoundingSphere.fromRectangle3D(e,a,n)),r.position||delete i.attributes.position,new j.Geometry({attributes:i.attributes,indices:i.indices,primitiveType:i.primitiveType,boundingSphere:o,offsetAttribute:t._offsetAttribute})},g.createShadowVolume=function(t,e,a){var r=t._granularity,n=t._ellipsoid,e=e(r,n),a=a(r,n);return new g({rectangle:t._rectangle,rotation:t._rotation,ellipsoid:n,stRotation:t._stRotation,granularity:r,extrudedHeight:a,height:e,vertexFormat:at.VertexFormat.POSITION_ONLY,shadowVolume:!0})},new Q.Rectangle),E=[new Q.Cartesian2,new Q.Cartesian2,new Q.Cartesian2],F=new j.Matrix2,G=new Q.Cartographic;return Object.defineProperties(g.prototype,{rectangle:{get:function(){return X.defined(this._rotatedRectangle)||(this._rotatedRectangle=d(this._rectangle,this._granularity,this._rotation,this._ellipsoid)),this._rotatedRectangle}},textureCoordinateRotationPoints:{get:function(){return X.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(t){if(0===t._stRotation)return[0,0,0,1,1,0];for(var e=Q.Rectangle.clone(t._rectangle,_),a=t._granularity,r=t._ellipsoid,e=d(e,a,t._rotation-t._stRotation,r,_),n=E,i=(n[0].x=e.west,n[0].y=e.south,n[1].x=e.west,n[1].y=e.north,n[2].x=e.east,n[2].y=e.south,t.rectangle),o=j.Matrix2.fromRotation(t._stRotation,F),s=Q.Rectangle.center(i,G),l=0;l<3;++l){var u=n[l];u.x-=s.longitude,u.y-=s.latitude,j.Matrix2.multiplyByVector(o,u,u),u.x+=s.longitude,u.y+=s.latitude,u.x=(u.x-i.west)/i.width,u.y=(u.y-i.south)/i.height}return a=n[0],r=n[1],e=n[2],t=new Array(6),Q.Cartesian2.pack(a,t),Q.Cartesian2.pack(r,t,2),Q.Cartesian2.pack(e,t,4),t}(this)),this._textureCoordinateRotationPoints}}}),function(t,e){return(t=X.defined(e)?g.unpack(t,e):t)._ellipsoid=Q.Ellipsoid.clone(t._ellipsoid),t._rectangle=Q.Rectangle.clone(t._rectangle),g.createGeometry(t)}});
