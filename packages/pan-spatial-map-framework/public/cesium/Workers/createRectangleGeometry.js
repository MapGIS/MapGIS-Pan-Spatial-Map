define(["./when-ae2e0b60","./Cartesian2-38b35910","./GeometryOffsetAttribute-b02d5bb9","./Transforms-07a9fab5","./Check-f996273c","./ComponentDatatype-e44126e4","./GeometryAttribute-586bf52c","./GeometryAttributes-5ce4955a","./GeometryInstance-eab27e6b","./GeometryPipeline-88f05837","./IndexDatatype-516320ea","./Math-5bbcea10","./PolygonPipeline-06aa4301","./RectangleGeometryLibrary-6b59569e","./VertexFormat-90d15264","./combine-276652d0","./RuntimeError-ac2797b4","./WebGLConstants-35626ea2","./AttributeCompression-25f42564","./EncodedCartesian3-d40e98d6","./IntersectionTests-f49c7cd3","./Plane-45ad3143","./EllipsoidRhumbLine-af7b5ebe"],function(X,Q,W,S,t,J,j,r,$,tt,et,Z,at,I,K,e,a,n,i,o,s,l,u){"use strict";var rt=new Q.Cartesian3,nt=new Q.Cartesian3,it=new Q.Cartesian3,ot=new Q.Cartesian3,c=new Q.Rectangle,k=new Q.Cartesian2,m=new S.BoundingSphere,d=new S.BoundingSphere;function st(t,e){var a=new j.Geometry({attributes:new r.GeometryAttributes,primitiveType:j.PrimitiveType.TRIANGLES});return a.attributes.position=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:e.positions}),t.normal&&(a.attributes.normal=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:e.normals})),t.tangent&&(a.attributes.tangent=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:e.tangents})),t.bitangent&&(a.attributes.bitangent=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:e.bitangents})),a}var lt=new Q.Cartesian3,ut=new Q.Cartesian3;function ct(c,m){for(var t=c._vertexFormat,p=c._ellipsoid,c=m.height,e=m.width,d=m.northCap,g=m.southCap,y=0,f=c,h=c,a=0,r=(d&&(--h,a+=y=1),g&&(--f,--h,a+=1),a+=e*h,t.position?new Float64Array(3*a):void 0),n=t.st?new Float32Array(2*a):void 0,i=0,b=0,o=rt,s=k,_=Number.MAX_VALUE,v=Number.MAX_VALUE,A=-Number.MAX_VALUE,x=-Number.MAX_VALUE,w=y;w<f;++w)for(var C=0;C<e;++C)I.RectangleGeometryLibrary.computePosition(m,p,t.st,w,C,o,s),r[i++]=o.x,r[i++]=o.y,r[i++]=o.z,t.st&&(n[b++]=s.x,n[b++]=s.y,_=Math.min(_,s.x),v=Math.min(v,s.y),A=Math.max(A,s.x),x=Math.max(x,s.y));if(d&&(I.RectangleGeometryLibrary.computePosition(m,p,t.st,0,0,o,s),r[i++]=o.x,r[i++]=o.y,r[i++]=o.z,t.st&&(n[b++]=s.x,n[b++]=s.y,_=s.x,v=s.y,A=s.x,x=s.y)),g&&(I.RectangleGeometryLibrary.computePosition(m,p,t.st,c-1,0,o,s),r[i++]=o.x,r[i++]=o.y,r[i]=o.z,t.st&&(n[b++]=s.x,n[b]=s.y,_=Math.min(_,s.x),v=Math.min(v,s.y),A=Math.max(A,s.x),x=Math.max(x,s.y))),t.st&&(_<0||v<0||1<A||1<x))for(var R=0;R<n.length;R+=2)n[R]=(n[R]-_)/(A-_),n[R+1]=(n[R+1]-v)/(x-v);for(var y=function(t,e,c,m){var a=t.length,r=e.normal?new Float32Array(a):void 0,n=e.tangent?new Float32Array(a):void 0,i=e.bitangent?new Float32Array(a):void 0,o=0,s=ot,l=it,u=nt;if(e.normal||e.tangent||e.bitangent)for(var p=0;p<a;p+=3){var d=Q.Cartesian3.fromArray(t,p,rt),g=o+1,y=o+2,u=c.geodeticSurfaceNormal(d,u);(e.tangent||e.bitangent)&&(Q.Cartesian3.cross(Q.Cartesian3.UNIT_Z,u,l),S.Matrix3.multiplyByVector(m,l,l),Q.Cartesian3.normalize(l,l),e.bitangent&&Q.Cartesian3.normalize(Q.Cartesian3.cross(u,l,s),s)),e.normal&&(r[o]=u.x,r[g]=u.y,r[y]=u.z),e.tangent&&(n[o]=l.x,n[g]=l.y,n[y]=l.z),e.bitangent&&(i[o]=s.x,i[g]=s.y,i[y]=s.z),o+=3}return st(e,{positions:t,normals:r,tangents:n,bitangents:i})}(r,t,p,m.tangentRotationMatrix),c=6*(e-1)*(h-1),l=(d&&(c+=3*(e-1)),g&&(c+=3*(e-1)),et.IndexDatatype.createTypedArray(a,c)),E=0,u=0,F=0;F<h-1;++F){for(var G=0;G<e-1;++G){var P=E,V=P+e,L=V+1,D=P+1;l[u++]=P,l[u++]=V,l[u++]=D,l[u++]=D,l[u++]=V,l[u++]=L,++E}++E}if(d||g){var M,T,O=a-1,N=a-1;if(d&&g&&(O=a-2),E=0,d)for(F=0;F<e-1;F++)T=(M=E)+1,l[u++]=O,l[u++]=M,l[u++]=T,++E;if(g)for(E=(h-1)*e,F=0;F<e-1;F++)T=(M=E)+1,l[u++]=M,l[u++]=N,l[u++]=T,++E}return y.indices=l,t.st&&(y.attributes.st=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:n})),y}function mt(t,e,a,r,n){return t[e++]=r[a],t[e++]=r[a+1],t[e++]=r[a+2],t[e++]=n[a],t[e++]=n[a+1],t[e]=n[a+2],t}function pt(t,e,a,r){return t[e++]=r[a],t[e++]=r[a+1],t[e++]=r[a],t[e]=r[a+1],t}var dt=new K.VertexFormat;function g(t,c){var m,e,p,d=t._shadowVolume,g=t._offsetAttribute,a=t._vertexFormat,y=t._extrudedHeight,f=t._surfaceHeight,h=t._ellipsoid,b=c.height,_=c.width,r=(d&&((r=K.VertexFormat.clone(a,dt)).normal=!0,t._vertexFormat=r),ct(t,c)),v=(d&&(t._vertexFormat=a),at.PolygonPipeline.scaleToGeodeticHeight(r.attributes.position.values,f,h,!1)),t=2*(u=(v=new Float64Array(v)).length),f=new Float64Array(t),A=(f.set(v),at.PolygonPipeline.scaleToGeodeticHeight(r.attributes.position.values,y,h)),y=(f.set(A,u),r.attributes.position.values=f,a.normal?new Float32Array(t):void 0),f=a.tangent?new Float32Array(t):void 0,x=a.bitangent?new Float32Array(t):void 0,w=a.st?new Float32Array(t/3*2):void 0;if(a.normal){for(e=r.attributes.normal.values,y.set(e),n=0;n<u;n++)e[n]=-e[n];y.set(e,u),r.attributes.normal.values=y}if(d){e=r.attributes.normal.values,a.normal||(r.attributes.normal=void 0);for(var y=new Float32Array(t),n=0;n<u;n++)e[n]=-e[n];y.set(e,u),r.attributes.extrudeDirection=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:y})}y=X.defined(g);if(y&&(V=u/3*2,P=new Uint8Array(V),P=g===W.GeometryOffsetAttribute.TOP?W.arrayFill(P,1,0,V/2):(p=g===W.GeometryOffsetAttribute.NONE?0:1,W.arrayFill(P,p)),r.attributes.applyOffset=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:P})),a.tangent){var C=r.attributes.tangent.values;for(f.set(C),n=0;n<u;n++)C[n]=-C[n];f.set(C,u),r.attributes.tangent.values=f}a.bitangent&&(V=r.attributes.bitangent.values,x.set(V),x.set(V,u),r.attributes.bitangent.values=x),a.st&&(m=r.attributes.st.values,w.set(m),w.set(m,u/3*2),r.attributes.st.values=w);var R=r.indices,E=R.length,F=u/3,G=et.IndexDatatype.createTypedArray(t/3,2*E);for(G.set(R),n=0;n<E;n+=3)G[n+E]=R[n+2]+F,G[n+1+E]=R[n+1]+F,G[n+2+E]=R[n]+F;r.indices=G;var P=c.northCap,f=c.southCap,V=b,x=2,w=0,t=4,c=4,b=(P&&(--x,--V,w+=1,t-=2,--c),f&&(--x,--V,w+=1,t-=2,--c),2*((w+=x*_+2*V-t)+c)),i=new Float64Array(3*b),o=d?new Float32Array(3*b):void 0,L=y?new Uint8Array(b):void 0,D=a.st?new Float32Array(2*b):void 0,M=g===W.GeometryOffsetAttribute.TOP,T=(y&&!M&&(p=g===W.GeometryOffsetAttribute.ALL?1:0,L=W.arrayFill(L,p)),0),O=0,s=0,N=0,S=_*V;for(n=0;n<S;n+=_)i=mt(i,T,l=3*n,v,A),T+=6,a.st&&(D=pt(D,O,2*n,m),O+=4),d&&(s+=3,o[s++]=e[l],o[s++]=e[l+1],o[s++]=e[l+2]),M&&(L[N++]=1,N+=1);if(f){var I=P?1+S:S,l=3*I;for(n=0;n<2;n++)i=mt(i,T,l,v,A),T+=6,a.st&&(D=pt(D,O,2*I,m),O+=4),d&&(s+=3,o[s++]=e[l],o[s++]=e[l+1],o[s++]=e[l+2]),M&&(L[N++]=1,N+=1)}else for(n=S-_;n<S;n++)i=mt(i,T,l=3*n,v,A),T+=6,a.st&&(D=pt(D,O,2*n,m),O+=4),d&&(s+=3,o[s++]=e[l],o[s++]=e[l+1],o[s++]=e[l+2]),M&&(L[N++]=1,N+=1);for(n=S-1;0<n;n-=_)i=mt(i,T,l=3*n,v,A),T+=6,a.st&&(D=pt(D,O,2*n,m),O+=4),d&&(s+=3,o[s++]=e[l],o[s++]=e[l+1],o[s++]=e[l+2]),M&&(L[N++]=1,N+=1);if(P){var k=S;for(l=3*k,n=0;n<2;n++)i=mt(i,T,l,v,A),T+=6,a.st&&(D=pt(D,O,2*k,m),O+=4),d&&(s+=3,o[s++]=e[l],o[s++]=e[l+1],o[s++]=e[l+2]),M&&(L[N++]=1,N+=1)}else for(n=_-1;0<=n;n--)i=mt(i,T,l=3*n,v,A),T+=6,a.st&&(D=pt(D,O,2*n,m),O+=4),d&&(s+=3,o[s++]=e[l],o[s++]=e[l+1],o[s++]=e[l+2]),M&&(L[N++]=1,N+=1);var x=function(c,t,m){var e=c.length,a=t.normal?new Float32Array(e):void 0,r=t.tangent?new Float32Array(e):void 0,n=t.bitangent?new Float32Array(e):void 0,i=0,o=0,p=0,d=!0,s=ot,l=it,u=nt;if(t.normal||t.tangent||t.bitangent)for(var g=0;g<e;g+=6){var y,f=Q.Cartesian3.fromArray(c,g,rt),h=Q.Cartesian3.fromArray(c,(g+6)%e,lt);d&&(y=Q.Cartesian3.fromArray(c,(g+3)%e,ut),Q.Cartesian3.subtract(h,f,h),Q.Cartesian3.subtract(y,f,y),u=Q.Cartesian3.normalize(Q.Cartesian3.cross(y,h,u),u),d=!1),Q.Cartesian3.equalsEpsilon(h,f,Z.CesiumMath.EPSILON10)&&(d=!0),(t.tangent||t.bitangent)&&(s=m.geodeticSurfaceNormal(f,s),t.tangent&&(l=Q.Cartesian3.normalize(Q.Cartesian3.cross(s,u,l),l))),t.normal&&(a[i++]=u.x,a[i++]=u.y,a[i++]=u.z,a[i++]=u.x,a[i++]=u.y,a[i++]=u.z),t.tangent&&(r[o++]=l.x,r[o++]=l.y,r[o++]=l.z,r[o++]=l.x,r[o++]=l.y,r[o++]=l.z),t.bitangent&&(n[p++]=s.x,n[p++]=s.y,n[p++]=s.z,n[p++]=s.x,n[p++]=s.y,n[p++]=s.z)}return st(t,{positions:c,normals:a,tangents:r,bitangents:n})}(i,a,h),H=(a.st&&(x.attributes.st=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:D})),d&&(x.attributes.extrudeDirection=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:o})),y&&(x.attributes.applyOffset=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:L})),et.IndexDatatype.createTypedArray(b,6*w)),u=i.length/3,z=0;for(n=0;n<u-1;n+=2){var B,U=((B=n)+2)%u,Y=Q.Cartesian3.fromArray(i,3*B,lt),q=Q.Cartesian3.fromArray(i,3*U,ut);Q.Cartesian3.equalsEpsilon(Y,q,Z.CesiumMath.EPSILON10)||(q=(2+(Y=(B+1)%u))%u,H[z++]=B,H[z++]=Y,H[z++]=U,H[z++]=U,H[z++]=Y,H[z++]=q)}return x.indices=H,(x=tt.GeometryPipeline.combineInstances([new $.GeometryInstance({geometry:r}),new $.GeometryInstance({geometry:x})]))[0]}var y=[new Q.Cartesian3,new Q.Cartesian3,new Q.Cartesian3,new Q.Cartesian3],f=new Q.Cartographic,h=new Q.Cartographic;function b(t,e,a,r,n){if(0===a)return Q.Rectangle.clone(t,n);var t=I.RectangleGeometryLibrary.computeOptions(t,e,a,0,c,f),e=t.height,a=t.width,i=y;return I.RectangleGeometryLibrary.computePosition(t,r,!1,0,0,i[0]),I.RectangleGeometryLibrary.computePosition(t,r,!1,0,a-1,i[1]),I.RectangleGeometryLibrary.computePosition(t,r,!1,e-1,0,i[2]),I.RectangleGeometryLibrary.computePosition(t,r,!1,e-1,a-1,i[3]),Q.Rectangle.fromCartesianArray(i,r,n)}function p(t){var e=(t=X.defaultValue(t,X.defaultValue.EMPTY_OBJECT)).rectangle,a=X.defaultValue(t.height,0),r=X.defaultValue(t.extrudedHeight,a);this._rectangle=Q.Rectangle.clone(e),this._granularity=X.defaultValue(t.granularity,Z.CesiumMath.RADIANS_PER_DEGREE),this._ellipsoid=Q.Ellipsoid.clone(X.defaultValue(t.ellipsoid,Q.Ellipsoid.WGS84)),this._surfaceHeight=Math.max(a,r),this._rotation=X.defaultValue(t.rotation,0),this._stRotation=X.defaultValue(t.stRotation,0),this._vertexFormat=K.VertexFormat.clone(X.defaultValue(t.vertexFormat,K.VertexFormat.DEFAULT)),this._extrudedHeight=Math.min(a,r),this._shadowVolume=X.defaultValue(t.shadowVolume,!1),this._workerName="createRectangleGeometry",this._offsetAttribute=t.offsetAttribute,this._rotatedRectangle=void 0,this._textureCoordinateRotationPoints=void 0}p.packedLength=Q.Rectangle.packedLength+Q.Ellipsoid.packedLength+K.VertexFormat.packedLength+7,p.pack=function(t,e,a){return a=X.defaultValue(a,0),Q.Rectangle.pack(t._rectangle,e,a),a+=Q.Rectangle.packedLength,Q.Ellipsoid.pack(t._ellipsoid,e,a),a+=Q.Ellipsoid.packedLength,K.VertexFormat.pack(t._vertexFormat,e,a),a+=K.VertexFormat.packedLength,e[a++]=t._granularity,e[a++]=t._surfaceHeight,e[a++]=t._rotation,e[a++]=t._stRotation,e[a++]=t._extrudedHeight,e[a++]=t._shadowVolume?1:0,e[a]=X.defaultValue(t._offsetAttribute,-1),e};var _=new Q.Rectangle,v=Q.Ellipsoid.clone(Q.Ellipsoid.UNIT_SPHERE),A={rectangle:_,ellipsoid:v,vertexFormat:dt,granularity:void 0,height:void 0,rotation:void 0,stRotation:void 0,extrudedHeight:void 0,shadowVolume:void 0,offsetAttribute:void 0},x=(p.unpack=function(t,e,a){e=X.defaultValue(e,0);var r=Q.Rectangle.unpack(t,e,_),c=(e+=Q.Rectangle.packedLength,Q.Ellipsoid.unpack(t,e,v)),m=(e+=Q.Ellipsoid.packedLength,K.VertexFormat.unpack(t,e,dt)),n=(e+=K.VertexFormat.packedLength,t[e++]),i=t[e++],o=t[e++],s=t[e++],l=t[e++],u=1===t[e++],t=t[e];return X.defined(a)?(a._rectangle=Q.Rectangle.clone(r,a._rectangle),a._ellipsoid=Q.Ellipsoid.clone(c,a._ellipsoid),a._vertexFormat=K.VertexFormat.clone(m,a._vertexFormat),a._granularity=n,a._surfaceHeight=i,a._rotation=o,a._stRotation=s,a._extrudedHeight=l,a._shadowVolume=u,a._offsetAttribute=-1===t?void 0:t,a):(A.granularity=n,A.height=i,A.rotation=o,A.stRotation=s,A.extrudedHeight=l,A.shadowVolume=u,A.offsetAttribute=-1===t?void 0:t,new p(A))},p.computeRectangle=function(t,e){var a=(t=X.defaultValue(t,X.defaultValue.EMPTY_OBJECT)).rectangle,r=X.defaultValue(t.granularity,Z.CesiumMath.RADIANS_PER_DEGREE),n=X.defaultValue(t.ellipsoid,Q.Ellipsoid.WGS84);return b(a,r,X.defaultValue(t.rotation,0),n,e)},new S.Matrix3),w=new S.Quaternion,C=new Q.Cartographic,R=(p.createGeometry=function(t){var e,a,r,n,i,o,s,l,u;if(!Z.CesiumMath.equalsEpsilon(t._rectangle.north,t._rectangle.south,Z.CesiumMath.EPSILON10)&&!Z.CesiumMath.equalsEpsilon(t._rectangle.east,t._rectangle.west,Z.CesiumMath.EPSILON10))return e=t._rectangle,a=t._ellipsoid,n=t._rotation,s=t._stRotation,r=t._vertexFormat,o=I.RectangleGeometryLibrary.computeOptions(e,t._granularity,n,s,c,f,h),l=x,0!==s||0!==n?(n=Q.Rectangle.center(e,C),n=a.geodeticSurfaceNormalCartographic(n,lt),S.Quaternion.fromAxisAngle(n,-s,w),S.Matrix3.fromQuaternion(w,l)):S.Matrix3.clone(S.Matrix3.IDENTITY,l),n=t._surfaceHeight,s=t._extrudedHeight,u=!Z.CesiumMath.equalsEpsilon(n,s,0,Z.CesiumMath.EPSILON2),o.lonScalar=1/t._rectangle.width,o.latScalar=1/t._rectangle.height,o.tangentRotationMatrix=l,e=t._rectangle,o=u?(i=g(t,o),l=S.BoundingSphere.fromRectangle3D(e,a,n,d),u=S.BoundingSphere.fromRectangle3D(e,a,s,m),S.BoundingSphere.union(l,u)):((i=ct(t,o)).attributes.position.values=at.PolygonPipeline.scaleToGeodeticHeight(i.attributes.position.values,n,a,!1),X.defined(t._offsetAttribute)&&(s=i.attributes.position.values.length,l=new Uint8Array(s/3),u=t._offsetAttribute===W.GeometryOffsetAttribute.NONE?0:1,W.arrayFill(l,u),i.attributes.applyOffset=new j.GeometryAttribute({componentDatatype:J.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:l})),S.BoundingSphere.fromRectangle3D(e,a,n)),r.position||delete i.attributes.position,new j.Geometry({attributes:i.attributes,indices:i.indices,primitiveType:i.primitiveType,boundingSphere:o,offsetAttribute:t._offsetAttribute})},p.createShadowVolume=function(t,e,a){var r=t._granularity,n=t._ellipsoid,e=e(r,n),a=a(r,n);return new p({rectangle:t._rectangle,rotation:t._rotation,ellipsoid:n,stRotation:t._stRotation,granularity:r,extrudedHeight:a,height:e,vertexFormat:K.VertexFormat.POSITION_ONLY,shadowVolume:!0})},new Q.Rectangle),E=[new Q.Cartesian2,new Q.Cartesian2,new Q.Cartesian2],F=new j.Matrix2,G=new Q.Cartographic;return Object.defineProperties(p.prototype,{rectangle:{get:function(){return X.defined(this._rotatedRectangle)||(this._rotatedRectangle=b(this._rectangle,this._granularity,this._rotation,this._ellipsoid)),this._rotatedRectangle}},textureCoordinateRotationPoints:{get:function(){return X.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(t){if(0===t._stRotation)return[0,0,0,1,1,0];for(var e=Q.Rectangle.clone(t._rectangle,R),a=t._granularity,r=t._ellipsoid,e=b(e,a,t._rotation-t._stRotation,r,R),n=E,i=(n[0].x=e.west,n[0].y=e.south,n[1].x=e.west,n[1].y=e.north,n[2].x=e.east,n[2].y=e.south,t.rectangle),o=j.Matrix2.fromRotation(t._stRotation,F),s=Q.Rectangle.center(i,G),l=0;l<3;++l){var u=n[l];u.x-=s.longitude,u.y-=s.latitude,j.Matrix2.multiplyByVector(o,u,u),u.x+=s.longitude,u.y+=s.latitude,u.x=(u.x-i.west)/i.width,u.y=(u.y-i.south)/i.height}return a=n[0],r=n[1],e=n[2],t=new Array(6),Q.Cartesian2.pack(a,t),Q.Cartesian2.pack(r,t,2),Q.Cartesian2.pack(e,t,4),t}(this)),this._textureCoordinateRotationPoints}}}),function(t,e){return(t=X.defined(e)?p.unpack(t,e):t)._ellipsoid=Q.Ellipsoid.clone(t._ellipsoid),t._rectangle=Q.Rectangle.clone(t._rectangle),p.createGeometry(t)}});
