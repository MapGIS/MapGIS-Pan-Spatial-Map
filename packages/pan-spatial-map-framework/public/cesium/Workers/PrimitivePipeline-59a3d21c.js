define(["exports","./Transforms-afef28e3","./ComponentDatatype-2104c626","./when-695b7bde","./Check-c47ad5ed","./Cartesian2-8dbd81c1","./GeometryAttribute-8921fd23","./GeometryAttributes-5198def4","./GeometryPipeline-401060df","./IndexDatatype-a458492e","./WebMercatorProjection-49ed6c46"],function(e,w,A,V,t,m,P,k,D,C,h){"use strict";function f(e,t,r){e=V.defaultValue(e,0),t=V.defaultValue(t,0),r=V.defaultValue(r,0),this.value=new Float32Array([e,t,r])}function O(e,t){for(var e=e.attributes,r=e.position,n=r.values.length/r.componentsPerAttribute,i=(e.batchId=new P.GeometryAttribute({componentDatatype:A.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(n)}),e.batchId.values),o=0;o<n;++o)i[o]=t}function g(e){var t=e.instances,u=e.projection,f=e.elementIndexUintSupported,c=e.scene3DOnly,m=e.vertexCacheOptimize,h=e.compressVertices,e=e.modelMatrix,r=t.length;for(p=0;p<r;++p)if(V.defined(t[p].geometry)){t[p].geometry.primitiveType;break}var n=t,l=!c,g=n.length;if(!l&&1<g)for(var y=n[0].modelMatrix,i=1;i<g;++i)if(!w.Matrix4.equals(y,n[i].modelMatrix)){l=!0;break}if(l)for(i=0;i<g;++i)V.defined(n[i].geometry)&&D.GeometryPipeline.transformToWorldCoordinates(n[i]);else w.Matrix4.multiplyTransformation(e,n[0].modelMatrix,e);if(!c)for(p=0;p<r;++p)V.defined(t[p].geometry)&&D.GeometryPipeline.splitLongitude(t[p]);for(var b=t,v=b.length,o=0;o<v;++o){var G=b[o];V.defined(G.geometry)?O(G.geometry,o):V.defined(G.westHemisphereGeometry)&&V.defined(G.eastHemisphereGeometry)&&(O(G.westHemisphereGeometry,o),O(G.eastHemisphereGeometry,o))}if(m)for(p=0;p<r;++p){var a=t[p];V.defined(a.geometry)?(D.GeometryPipeline.reorderForPostVertexCache(a.geometry),D.GeometryPipeline.reorderForPreVertexCache(a.geometry)):V.defined(a.westHemisphereGeometry)&&V.defined(a.eastHemisphereGeometry)&&(D.GeometryPipeline.reorderForPostVertexCache(a.westHemisphereGeometry),D.GeometryPipeline.reorderForPreVertexCache(a.westHemisphereGeometry),D.GeometryPipeline.reorderForPostVertexCache(a.eastHemisphereGeometry),D.GeometryPipeline.reorderForPreVertexCache(a.eastHemisphereGeometry))}var x=D.GeometryPipeline.combineInstances(t);for(r=x.length,p=0;p<r;++p){var s,d,S,P,k=(s=x[p]).attributes;if(c)for(d in k)k.hasOwnProperty(d)&&k[d].componentDatatype===A.ComponentDatatype.DOUBLE&&D.GeometryPipeline.encodeAttribute(s,d,d+"3DHigh",d+"3DLow");else for(d in k)k.hasOwnProperty(d)&&k[d].componentDatatype===A.ComponentDatatype.DOUBLE&&(D.GeometryPipeline.projectTo2D(s,d,S=d+"3D",P=d+"2D",u),V.defined(s.boundingSphere)&&"position"===d&&(s.boundingSphereCV=w.BoundingSphere.fromVertices(s.attributes.position2D.values)),D.GeometryPipeline.encodeAttribute(s,S,S+"High",S+"Low"),D.GeometryPipeline.encodeAttribute(s,P,P+"High",P+"Low"));h&&D.GeometryPipeline.compressVertices(s)}if(!f){for(var C=[],r=x.length,p=0;p<r;++p)s=x[p],C=C.concat(D.GeometryPipeline.fitToUnsignedShortIndices(s));x=C}return x}function l(e,t,r,n){for(var i,o,a,s=n.length-1,u=(a=0<=s?(i=(s=n[s]).offset+s.count,r[o=s.index].indices.length):r[o=i=0].indices.length,e.length),d=0;d<u;++d){var p=e[d][t];V.defined(p)&&(a<i+(p=p.indices.length)&&(i=0,a=r[++o].indices.length),n.push({index:o,offset:i,count:p}),i+=p)}}Object.defineProperties(f.prototype,{componentDatatype:{get:function(){return A.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),f.fromCartesian3=function(e){return new f(e.x,e.y,e.z)},f.toValue=function(e,t){return(t=V.defined(t)?t:new Float32Array([e.x,e.y,e.z]))[0]=e.x,t[1]=e.y,t[2]=e.z,t};var c={};function o(e,t){for(var r=e.length,n=0;n<r;++n){o=i=d=s=a=void 0;var i,o,a=e[n],s=t,d=a.attributes;for(i in d)d.hasOwnProperty(i)&&(o=d[i],V.defined(o)&&V.defined(o.values)&&s.push(o.values.buffer));V.defined(a.indices)&&s.push(a.indices.buffer)}}function i(e){var t=e.length,r=1+(w.BoundingSphere.packedLength+1)*t,n=new Float32Array(r),i=0;n[i++]=t;for(var o=0;o<t;++o){var a=e[o];V.defined(a)?(n[i++]=1,w.BoundingSphere.pack(e[o],n,i)):n[i++]=0,i+=w.BoundingSphere.packedLength}return n}function r(e){for(var t=new Array(e[0]),r=0,n=1;n<e.length;)1===e[n++]&&(t[r]=w.BoundingSphere.unpack(e,n)),++r,n+=w.BoundingSphere.packedLength;return t}c.combineGeometry=function(e){for(var t,u,r,n,f,i,o=e.instances,a=o.length,c=!1,m=(0<a&&(0<(t=g(e)).length&&(u=D.GeometryPipeline.createAttributeLocations(t[0]),e.createPickOffsets&&(l(n=o,"geometry",f=t,i=[]),l(n,"westHemisphereGeometry",f,i),l(n,"eastHemisphereGeometry",f,i),n=i)),V.defined(o[0].attributes)&&V.defined(o[0].attributes.offset)&&(r=new Array(a),c=!0)),new Array(a)),h=new Array(a),s=0;s<a;++s){var d=o[s],p=d.geometry,p=(V.defined(p)&&(m[s]=p.boundingSphere,h[s]=p.boundingSphereCV,c&&(r[s]=d.geometry.offsetAttribute)),d.eastHemisphereGeometry),d=d.westHemisphereGeometry;V.defined(p)&&V.defined(d)&&(V.defined(p.boundingSphere)&&V.defined(d.boundingSphere)&&(m[s]=w.BoundingSphere.union(p.boundingSphere,d.boundingSphere)),V.defined(p.boundingSphereCV)&&V.defined(d.boundingSphereCV)&&(h[s]=w.BoundingSphere.union(p.boundingSphereCV,d.boundingSphereCV)))}return{geometries:t,modelMatrix:e.modelMatrix,attributeLocations:u,pickOffsets:n,offsetInstanceExtend:r,boundingSpheres:m,boundingSpheresCV:h}},c.packCreateGeometryResults=function(e,u){var t=new Float64Array(function(e){for(var t=1,r=e.length,n=0;n<r;n++){var i=e[n];if(++t,V.defined(i)){var o,a=i.attributes;for(o in t+=7+2*w.BoundingSphere.packedLength+(V.defined(i.indices)?i.indices.length:0),a)a.hasOwnProperty(o)&&V.defined(a[o])&&(t+=5+a[o].values.length)}}return t}(e)),r=[],f={},c=e.length,n=0;t[n++]=c;for(var m=0;m<c;m++){var i=e[m],o=V.defined(i);if(t[n++]=o?1:0,o){t[n++]=i.primitiveType,t[n++]=i.geometryType,t[n++]=V.defaultValue(i.offsetAttribute,-1);var a,o=V.defined(i.boundingSphere)?1:0,o=((t[n++]=o)&&w.BoundingSphere.pack(i.boundingSphere,t,n),n+=w.BoundingSphere.packedLength,V.defined(i.boundingSphereCV)?1:0),s=((t[n++]=o)&&w.BoundingSphere.pack(i.boundingSphereCV,t,n),n+=w.BoundingSphere.packedLength,i.attributes),d=[];for(a in s)s.hasOwnProperty(a)&&V.defined(s[a])&&(d.push(a),V.defined(f[a])||(f[a]=r.length,r.push(a)));t[n++]=d.length;for(var h=0;h<d.length;h++){var l=d[h],p=s[l];t[n++]=f[l],t[n++]=p.componentDatatype,t[n++]=p.componentsPerAttribute,t[n++]=p.normalize?1:0,t[n++]=p.values.length,t.set(p.values,n),n+=p.values.length}o=V.defined(i.indices)?i.indices.length:0;0<(t[n++]=o)&&(t.set(i.indices,n),n+=o)}}return u.push(t.buffer),{stringTable:r,packedData:t}},c.unpackCreateGeometryResults=function(e){for(var u=e.stringTable,t=e.packedData,r=new Array(t[0]),n=0,i=1;i<t.length;)if(1===t[i++]){var f,c,m=t[i++],h=t[i++],o=t[i++];-1===o&&(o=void 0),1===t[i++]&&(f=w.BoundingSphere.unpack(t,i)),i+=w.BoundingSphere.packedLength;1===t[i++]&&(c=w.BoundingSphere.unpack(t,i)),i+=w.BoundingSphere.packedLength;var l=new k.GeometryAttributes,g=t[i++];for(p=0;p<g;p++){for(var y=u[t[i++]],b=t[i++],v=t[i++],G=0!==t[i++],a=t[i++],s=A.ComponentDatatype.createTypedArray(b,a),d=0;d<a;d++)s[d]=t[i++];l[y]=new P.GeometryAttribute({componentDatatype:b,componentsPerAttribute:v,normalize:G,values:s})}if(0<(a=t[i++]))for(var x=s.length/v,S=C.IndexDatatype.createTypedArray(x,a),p=0;p<a;p++)S[p]=t[i++];r[n++]=new P.Geometry({primitiveType:m,geometryType:h,boundingSphere:f,boundingSphereCV:c,indices:S,attributes:l,offsetAttribute:o})}else r[n++]=void 0;return r},c.packCombineGeometryParameters=function(e,t){for(var r=e.createGeometryResults,n=r.length,i=0;i<n;i++)t.push(r[i].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:function(e,t){var r=e.length,n=new Float64Array(1+19*r),i=0;n[i++]=r;for(var o=0;o<r;o++){var a=e[o];w.Matrix4.pack(a.modelMatrix,n,i),i+=w.Matrix4.packedLength,V.defined(a.attributes)&&V.defined(a.attributes.offset)&&(a=a.attributes.offset.value,n[i]=a[0],n[i+1]=a[1],n[i+2]=a[2]),i+=3}return t.push(n.buffer),n}(e.instances,t),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof w.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},c.unpackCombineGeometryParameters=function(e){for(var t=function(e){for(var t=e,r=new Array(t[0]),n=0,i=1;i<t.length;){var o,a=w.Matrix4.unpack(t,i);i+=w.Matrix4.packedLength,V.defined(t[i])&&(o={offset:new f(t[i],t[i+1],t[i+2])}),i+=3,r[n++]={modelMatrix:a,attributes:o}}return r}(e.packedInstances),r=e.createGeometryResults,n=r.length,i=0,o=0;o<n;o++)for(var a=c.unpackCreateGeometryResults(r[o]),s=a.length,d=0;d<s;d++){var u=a[d];t[i].geometry=u,++i}var p=m.Ellipsoid.clone(e.ellipsoid);return{instances:t,ellipsoid:p,projection:new(e.isGeographic?w.GeographicProjection:h.WebMercatorProjection)(p),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:w.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},c.packCombineGeometryResults=function(e,t){V.defined(e.geometries)&&o(e.geometries,t);var r=i(e.boundingSpheres),n=i(e.boundingSpheresCV);return t.push(r.buffer,n.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r,boundingSpheresCV:n}},c.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r(e.boundingSpheres),boundingSpheresCV:r(e.boundingSpheresCV)}},e.PrimitivePipeline=c});
