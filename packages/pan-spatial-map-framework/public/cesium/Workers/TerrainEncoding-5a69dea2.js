define(["exports","./Transforms-afef28e3","./Cartesian2-8dbd81c1","./Check-c47ad5ed","./when-695b7bde","./AttributeCompression-9727be84","./ComponentDatatype-2104c626","./Math-09ca1a10"],function(t,f,p,a,x,l,d,h){"use strict";function e(e,t){this._ellipsoid=e,this._cameraPosition=new p.Cartesian3,this._cameraPositionInScaledSpace=new p.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,x.defined(t)&&(this.cameraPosition=t)}Object.defineProperties(e.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){var t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),i=p.Cartesian3.magnitudeSquared(t)-1;p.Cartesian3.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=i}}});var r=new p.Cartesian3,o=(e.prototype.isPointVisible=function(e){return M(this._ellipsoid.transformPositionToScaledSpace(e,r),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},e.prototype.isScaledSpacePointVisible=function(e){return M(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},new p.Cartesian3),n=(e.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){var i,a=this._ellipsoid,a=x.defined(t)&&t<0&&a.minimumRadius>-t?((i=o).x=this._cameraPosition.x/(a.radii.x+t),i.y=this._cameraPosition.y/(a.radii.y+t),i.z=this._cameraPosition.z/(a.radii.z+t),i.x*i.x+i.y*i.y+i.z*i.z-1):(i=this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared);return M(e,i,a)},e.prototype.computeHorizonCullingPoint=function(e,t,i){return m(this._ellipsoid,e,t,i)},p.Ellipsoid.clone(p.Ellipsoid.UNIT_SPHERE)),s=(e.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,a){return m(u(this._ellipsoid,i,n),e,t,a)},e.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,a,r){return N(this._ellipsoid,e,t,i,a,r)},e.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,a,r,o){return N(u(this._ellipsoid,r,n),e,t,i,a,o)},[]),c=(e.prototype.computeHorizonCullingPointFromRectangle=function(e,t,i){var e=p.Rectangle.subsample(e,t,0,s),a=f.BoundingSphere.fromPoints(e);if(!(p.Cartesian3.magnitude(a.center)<.1*t.minimumRadius))return this.computeHorizonCullingPoint(a.center,e,i)},new p.Cartesian3);function u(e,t,i){return x.defined(t)&&t<0&&e.minimumRadius>-t&&(t=p.Cartesian3.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,c),e=p.Ellipsoid.fromCartesian3(t,i)),e}function m(e,t,i,a){x.defined(a)||(a=new p.Cartesian3);for(var r=E(e,t),o=0,n=0,s=i.length;n<s;++n){var c=P(e,i[n],r);if(c<0)return;o=Math.max(o,c)}return z(r,o,a)}var y=new p.Cartesian3;function N(e,t,i,a,r,o){x.defined(o)||(o=new p.Cartesian3),a=x.defaultValue(a,3),r=x.defaultValue(r,p.Cartesian3.ZERO);for(var n=E(e,t),s=0,c=0,u=i.length;c<u;c+=a){y.x=i[c]+r.x,y.y=i[c+1]+r.y,y.z=i[c+2]+r.z;var d=P(e,y,n);if(d<0)return;s=Math.max(s,d)}return z(n,s,o)}function M(e,t,i){e=p.Cartesian3.subtract(e,t,r),t=-p.Cartesian3.dot(e,t);return!(i<0?0<t:i<t&&t*t/p.Cartesian3.magnitudeSquared(e)>i)}var T=new p.Cartesian3,b=new p.Cartesian3;function P(e,t,i){var e=e.transformPositionToScaledSpace(t,T),t=p.Cartesian3.magnitudeSquared(e),a=Math.sqrt(t),e=p.Cartesian3.divideByScalar(e,a,b),t=Math.max(1,t),a=1/Math.max(1,a);return 1/(p.Cartesian3.dot(e,i)*a-p.Cartesian3.magnitude(p.Cartesian3.cross(e,i,e))*(Math.sqrt(t-1)*a))}function z(e,t,i){if(!(t<=0||t===1/0||t!=t))return p.Cartesian3.multiplyByScalar(e,t,i)}var _=new p.Cartesian3;function E(e,t){return p.Cartesian3.equals(t,p.Cartesian3.ZERO)?t:(e.transformPositionToScaledSpace(t,_),p.Cartesian3.normalize(_,_))}var v={getHeight:function(e,t,i){return(e-i)*t+i}},H=new p.Cartesian3,S=(v.getPosition=function(e,t,i,a,r){e=t.cartesianToCartographic(e,H),i=v.getHeight(e.height,i,a);return p.Cartesian3.fromRadians(e.longitude,e.latitude,i,t,r)},Object.freeze({NONE:0,BITS12:1})),C=new p.Cartesian3,w=new p.Cartesian3,g=new p.Cartesian2,A=new f.Matrix4,I=new f.Matrix4,q=Math.pow(2,12);function i(e,t,i,a,r,o,u,m,l,h){var n,s,c,d=S.NONE;x.defined(t)&&x.defined(i)&&x.defined(a)&&x.defined(r)&&(c=t.minimum,t=t.maximum,t=p.Cartesian3.subtract(t,c,w),n=a-i,d=Math.max(p.Cartesian3.maximumComponent(t),n)<q-1?S.BITS12:S.NONE,n=f.Matrix4.inverseTransformation(r,new f.Matrix4),s=p.Cartesian3.negate(c,C),f.Matrix4.multiply(f.Matrix4.fromTranslation(s,A),n,n),(s=C).x=1/t.x,s.y=1/t.y,s.z=1/t.z,f.Matrix4.multiply(f.Matrix4.fromScale(s,A),n,n),s=f.Matrix4.clone(r),f.Matrix4.setTranslation(s,p.Cartesian3.ZERO,s),r=f.Matrix4.clone(r,new f.Matrix4),c=f.Matrix4.fromTranslation(c,A),t=f.Matrix4.fromScale(t,I),c=f.Matrix4.multiply(c,t,A),f.Matrix4.multiply(r,c,r),f.Matrix4.multiply(s,c,s)),this.quantization=d,this.minimumHeight=i,this.maximumHeight=a,this.center=p.Cartesian3.clone(e),this.toScaledENU=n,this.fromScaledENU=r,this.matrix=s,this.hasVertexNormals=o,this.hasWebMercatorT=x.defaultValue(u,!1),this.hasGeodeticSurfaceNormals=x.defaultValue(m,!1),this.exaggeration=x.defaultValue(l,1),this.exaggerationRelativeHeight=x.defaultValue(h,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}i.prototype.encode=function(e,t,i,a,r,u,o,n){var s,c,d,m=a.x,a=a.y;return this.quantization===S.BITS12?((i=f.Matrix4.multiplyByPoint(this.toScaledENU,i,C)).x=h.CesiumMath.clamp(i.x,0,1),i.y=h.CesiumMath.clamp(i.y,0,1),i.z=h.CesiumMath.clamp(i.z,0,1),s=this.maximumHeight-this.minimumHeight,s=h.CesiumMath.clamp((r-this.minimumHeight)/s,0,1),p.Cartesian2.fromElements(i.x,i.y,g),d=l.AttributeCompression.compressTextureCoordinates(g),p.Cartesian2.fromElements(i.z,s,g),s=l.AttributeCompression.compressTextureCoordinates(g),p.Cartesian2.fromElements(m,a,g),c=l.AttributeCompression.compressTextureCoordinates(g),e[t++]=d,e[t++]=s,e[t++]=c,this.hasWebMercatorT&&(p.Cartesian2.fromElements(o,0,g),d=l.AttributeCompression.compressTextureCoordinates(g),e[t++]=d)):(p.Cartesian3.subtract(i,this.center,C),e[t++]=C.x,e[t++]=C.y,e[t++]=C.z,e[t++]=r,e[t++]=m,e[t++]=a,this.hasWebMercatorT&&(e[t++]=o)),this.hasVertexNormals&&(e[t++]=l.AttributeCompression.octPackFloat(u)),this.hasGeodeticSurfaceNormals&&(e[t++]=n.x,e[t++]=n.y,e[t++]=n.z),t};var V=new p.Cartesian3,G=new p.Cartesian3,O=(i.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(!this.hasGeodeticSurfaceNormals)for(var a=this.stride,r=e.length/a,o=(this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets(),this.stride),n=0;n<r;n++){for(var s=0;s<a;s++)t[n*o+s]=e[n*a+s];var c=this.decodePosition(t,n,V),c=i.geodeticSurfaceNormal(c,G),d=n*o+this._offsetGeodeticSurfaceNormal;t[d]=c.x,t[d+1]=c.y,t[d+2]=c.z}},i.prototype.removeGeodeticSurfaceNormals=function(e,t){if(this.hasGeodeticSurfaceNormals)for(var i=this.stride,a=e.length/i,r=(this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets(),this.stride),o=0;o<a;o++)for(var n=0;n<r;n++)t[o*r+n]=e[o*i+n]},i.prototype.decodePosition=function(e,t,i){var a;return x.defined(i)||(i=new p.Cartesian3),t*=this.stride,this.quantization===S.BITS12?(a=l.AttributeCompression.decompressTextureCoordinates(e[t],g),i.x=a.x,i.y=a.y,a=l.AttributeCompression.decompressTextureCoordinates(e[t+1],g),i.z=a.x,f.Matrix4.multiplyByPoint(this.fromScaledENU,i,i)):(i.x=e[t],i.y=e[t+1],i.z=e[t+2],p.Cartesian3.add(i,this.center,i))},i.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);var a,r=this.exaggeration,o=this.exaggerationRelativeHeight;return 1!==r&&this.hasGeodeticSurfaceNormals&&(a=this.decodeGeodeticSurfaceNormal(e,t,G),e=this.decodeHeight(e,t),t=v.getHeight(e,r,o)-e,i.x+=a.x*t,i.y+=a.y*t,i.z+=a.z*t),i},i.prototype.decodeTextureCoordinates=function(e,t,i){return x.defined(i)||(i=new p.Cartesian2),t*=this.stride,this.quantization===S.BITS12?l.AttributeCompression.decompressTextureCoordinates(e[t+2],i):p.Cartesian2.fromElements(e[t+4],e[t+5],i)},i.prototype.decodeHeight=function(e,t){return t*=this.stride,this.quantization!==S.BITS12?e[t+3]:l.AttributeCompression.decompressTextureCoordinates(e[t+1],g).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight},i.prototype.decodeWebMercatorT=function(e,t){return t*=this.stride,this.quantization===S.BITS12?l.AttributeCompression.decompressTextureCoordinates(e[t+3],g).x:e[t+6]},i.prototype.getOctEncodedNormal=function(e,t,i){e=e[t=t*this.stride+this._offsetVertexNormal]/256,t=Math.floor(e);return p.Cartesian2.fromElements(t,256*(e-t),i)},i.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return t=t*this.stride+this._offsetGeodeticSurfaceNormal,i.x=e[t],i.y=e[t+1],i.z=e[t+2],i},i.prototype._calculateStrideAndOffsets=function(){var e=0;this.quantization===S.BITS12?e+=3:e+=6,this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e},{position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2}),B={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};i.prototype.getAttributes=function(i){var e,t,a=d.ComponentDatatype.FLOAT,r=d.ComponentDatatype.getSizeInBytes(a),o=this.stride*r,n=0,s=[];function c(e,t){s.push({index:e,vertexBuffer:i,componentDatatype:a,componentsPerAttribute:t,offsetInBytes:n,strideInBytes:o}),n+=t*r}return this.quantization===S.NONE?(c(O.position3DAndHeight,4),e=2,e=(e+=this.hasWebMercatorT?1:0)+(this.hasVertexNormals?1:0),c(O.textureCoordAndEncodedNormals,e),this.hasGeodeticSurfaceNormals&&c(O.geodeticSurfaceNormal,3)):(e=this.hasWebMercatorT||this.hasVertexNormals,t=this.hasWebMercatorT&&this.hasVertexNormals,c(B.compressed0,e?4:3),t&&c(B.compressed1,1),this.hasGeodeticSurfaceNormals&&c(B.geodeticSurfaceNormal,3)),s},i.prototype.getAttributeLocations=function(){return this.quantization===S.NONE?O:B},i.clone=function(e,t){if(x.defined(e))return(t=x.defined(t)?t:new i).quantization=e.quantization,t.minimumHeight=e.minimumHeight,t.maximumHeight=e.maximumHeight,t.center=p.Cartesian3.clone(e.center),t.toScaledENU=f.Matrix4.clone(e.toScaledENU),t.fromScaledENU=f.Matrix4.clone(e.fromScaledENU),t.matrix=f.Matrix4.clone(e.matrix),t.hasVertexNormals=e.hasVertexNormals,t.hasWebMercatorT=e.hasWebMercatorT,t.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,t.exaggeration=e.exaggeration,t.exaggerationRelativeHeight=e.exaggerationRelativeHeight,t._calculateStrideAndOffsets(),t},t.EllipsoidalOccluder=e,t.TerrainEncoding=i});
