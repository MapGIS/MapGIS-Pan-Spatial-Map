define(["./AxisAlignedBoundingBox-d272def4","./Transforms-07a9fab5","./Cartesian2-38b35910","./when-ae2e0b60","./TerrainEncoding-9adc5a79","./Math-5bbcea10","./OrientedBoundingBox-771a38ca","./RuntimeError-ac2797b4","./WebMercatorProjection-cf614542","./createTaskProcessorWorker","./Check-f996273c","./combine-276652d0","./AttributeCompression-25f42564","./ComponentDatatype-e44126e4","./WebGLConstants-35626ea2","./EllipsoidTangentPlane-19622103","./IntersectionTests-f49c7cd3","./Plane-45ad3143"],function(Pe,fe,Ce,Me,Ae,xe,ye,Re,_e,e,t,i,n,a,r,o,s,u){"use strict";var We=Uint16Array.BYTES_PER_ELEMENT,Ne=Int32Array.BYTES_PER_ELEMENT,Fe=Uint32Array.BYTES_PER_ELEMENT,Oe=Float32Array.BYTES_PER_ELEMENT,ve=Float64Array.BYTES_PER_ELEMENT;function be(e,t,i){i=Me.defaultValue(i,xe.CesiumMath);for(var n=e.length,a=0;a<n;++a)if(i.equalsEpsilon(e[a],t,xe.CesiumMath.EPSILON12))return a;return-1}var Se=new Ce.Cartographic,we=new Ce.Cartesian3,Ye=new Ce.Cartesian3,ke=new Ce.Cartesian3,Ue=new fe.Matrix4;function Be(c,d,g,e,t,l,i,m,p,I,E){for(var T=m.length,n=0;n<T;++n){var a=m[n],r=a.cartographic,o=a.index,s=c.length,u=r.longitude,h=r.latitude,h=xe.CesiumMath.clamp(h,-xe.CesiumMath.PI_OVER_TWO,xe.CesiumMath.PI_OVER_TWO),r=r.height-i.skirtHeight,u=(i.hMin=Math.min(i.hMin,r),Ce.Cartographic.fromRadians(u,h,r,Se),I&&(Se.longitude+=p),I?n===T-1?Se.latitude+=E:0===n&&(Se.latitude-=E):Se.latitude+=p,i.ellipsoid.cartographicToCartesian(Se)),h=(c.push(u),d.push(r),g.push(Ce.Cartesian2.clone(g[o])),0<e.length&&e.push(e[o]),0<t.length&&t.push(t[o]),fe.Matrix4.multiplyByPoint(i.toENU,u,we),i.minimum),r=i.maximum,u=(Ce.Cartesian3.minimumByComponent(we,h,h),Ce.Cartesian3.maximumByComponent(we,r,r),i.lastBorderPoint);Me.defined(u)&&(h=u.index,l.push(h,s-1,s,s,o,h)),i.lastBorderPoint=a}}return e(function(e,t){e.ellipsoid=Ce.Ellipsoid.clone(e.ellipsoid),e.rectangle=Ce.Rectangle.clone(e.rectangle);var i=(e=function(c,d,g,e,t,l,m,i,p,I,E){var T,f,C,M;t=Me.defined(e)?(T=e.west,f=e.south,C=e.east,M=e.north,me=e.width,e.height):(T=xe.CesiumMath.toRadians(t.west),f=xe.CesiumMath.toRadians(t.south),C=xe.CesiumMath.toRadians(t.east),M=xe.CesiumMath.toRadians(t.north),me=xe.CesiumMath.toRadians(e.width),xe.CesiumMath.toRadians(e.height));var x,N,v=[f,M],b=[T,C],S=fe.Transforms.eastNorthUpToFixedFrame(d,g),w=fe.Matrix4.inverseTransformation(S,Ue);p&&(x=_e.WebMercatorProjection.geodeticLatitudeToMercatorAngle(f),N=1/(_e.WebMercatorProjection.geodeticLatitudeToMercatorAngle(M)-x));var B,P,A=1!==l,n=new DataView(c),y=Number.POSITIVE_INFINITY,R=Number.NEGATIVE_INFINITY,_=Ye,W=(_.x=Number.POSITIVE_INFINITY,_.y=Number.POSITIVE_INFINITY,_.z=Number.POSITIVE_INFINITY,ke),a=(W.x=Number.NEGATIVE_INFINITY,W.y=Number.NEGATIVE_INFINITY,W.z=Number.NEGATIVE_INFINITY,0),F=0,O=0;for(P=0;P<4;++P){var r=a,Y=(B=n.getUint32(r,!0),r+=Fe,xe.CesiumMath.toRadians(180*n.getFloat64(r,!0))),Y=(r+=ve,-1===be(b,Y)&&b.push(Y),xe.CesiumMath.toRadians(180*n.getFloat64(r,!0))),Y=(r+=ve,-1===be(v,Y)&&v.push(Y),r+=2*ve,n.getInt32(r,!0));r+=Ne,F+=Y,Y=n.getInt32(r,!0),O+=3*Y,a+=B+Fe}var k=[],U=[],o=new Array(F),V=new Array(F),H=new Array(F),L=p?new Array(F):[],D=A?new Array(F):[],G=new Array(O),j=[],z=[],q=[],J=[],s=0,K=0;for(P=a=0;P<4;++P){B=n.getUint32(a,!0);for(var Q=a+=Fe,X=xe.CesiumMath.toRadians(180*n.getFloat64(a,!0)),Z=(a+=ve,xe.CesiumMath.toRadians(180*n.getFloat64(a,!0))),$=(a+=ve,xe.CesiumMath.toRadians(180*n.getFloat64(a,!0))),ee=.5*$,te=(a+=ve,xe.CesiumMath.toRadians(180*n.getFloat64(a,!0))),ie=.5*te,ne=(a+=ve,n.getInt32(a,!0)),ae=(a+=Ne,n.getInt32(a,!0)),re=(a=a+Ne+Ne,new Array(ne)),oe=0;oe<ne;++oe){var se=X+n.getUint8(a++)*$,ue=(Se.longitude=se,Z+n.getUint8(a++)*te),u=(Se.latitude=ue,n.getFloat32(a,!0));if(a+=Oe,0!==u&&u<E&&(u*=-Math.pow(2,I)),u*=6371010,Se.height=u,-1!==be(b,se)||-1!==be(v,ue)){var he=be(k,Se,Ce.Cartographic);if(-1!==he){re[oe]=U[he];continue}k.push(Ce.Cartographic.clone(Se)),U.push(s)}re[oe]=s,Math.abs(se-T)<ee?j.push({index:s,cartographic:Ce.Cartographic.clone(Se)}):Math.abs(se-C)<ee?q.push({index:s,cartographic:Ce.Cartographic.clone(Se)}):Math.abs(ue-f)<ie?z.push({index:s,cartographic:Ce.Cartographic.clone(Se)}):Math.abs(ue-M)<ie&&J.push({index:s,cartographic:Ce.Cartographic.clone(Se)}),y=Math.min(u,y),R=Math.max(u,R),H[s]=u;he=g.cartographicToCartesian(Se),u=(o[s]=he,p&&(L[s]=(_e.WebMercatorProjection.geodeticLatitudeToMercatorAngle(ue)-x)*N),A&&(u=g.geodeticSurfaceNormal(he),D[s]=u),fe.Matrix4.multiplyByPoint(w,he,we),Ce.Cartesian3.minimumByComponent(we,_,_),Ce.Cartesian3.maximumByComponent(we,W,W),(se-T)/(C-T)),se=(u=xe.CesiumMath.clamp(u,0,1),(ue-f)/(M-f));se=xe.CesiumMath.clamp(se,0,1),V[s]=new Ce.Cartesian2(u,se),++s}for(var ce=3*ae,de=0;de<ce;++de,++K)G[K]=re[n.getUint16(a,!0)],a+=We;if(B!==a-Q)throw new Re.RuntimeError("Invalid terrain tile.")}o.length=s,V.length=s,H.length=s,p&&(L.length=s);A&&(D.length=s);var c=s,ge=K,i={hMin:y,lastBorderPoint:void 0,skirtHeight:i,toENU:w,ellipsoid:g,minimum:_,maximum:W},h=(j.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),z.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),q.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),J.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude}),1e-5);Be(o,H,V,L,D,G,i,j,-h*me,!0,-h*t),Be(o,H,V,L,D,G,i,z,-h*t,!1),Be(o,H,V,L,D,G,i,q,h*me,!0,h*t),Be(o,H,V,L,D,G,i,J,h*t,!1),0<j.length&&0<J.length&&(me=j[0].index,h=J[J.length-1].index,t=o.length-1,G.push(h,t,c,c,me,h));F=o.length;var le,t=fe.BoundingSphere.fromPoints(o);Me.defined(e)&&(le=ye.OrientedBoundingBox.fromRectangle(e,y,R,g));for(var me=new Ae.EllipsoidalOccluder(g).computeHorizonCullingPointPossiblyUnderEllipsoid(d,o,y),h=new Pe.AxisAlignedBoundingBox(_,W,d),pe=new Ae.TerrainEncoding(d,h,i.hMin,R,S,!1,p,A,l,m),Ie=new Float32Array(F*pe.stride),Ee=0,Te=0;Te<F;++Te)Ee=pe.encode(Ie,Ee,o[Te],V[Te],H[Te],void 0,L[Te],D[Te]);e=j.map(function(e){return e.index}).reverse(),d=z.map(function(e){return e.index}).reverse(),h=q.map(function(e){return e.index}).reverse(),i=J.map(function(e){return e.index}).reverse();return d.unshift(h[h.length-1]),d.push(e[0]),i.unshift(e[e.length-1]),i.push(h[0]),{vertices:Ie,indices:new Uint16Array(G),maximumHeight:R,minimumHeight:y,encoding:pe,boundingSphere3D:t,orientedBoundingBox:le,occludeePointInScaledSpace:me,vertexCountWithoutSkirts:c,indexCountWithoutSkirts:ge,westIndicesSouthToNorth:e,southIndicesEastToWest:d,eastIndicesNorthToSouth:h,northIndicesWestToEast:i}}(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.exaggerationRelativeHeight,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold)).vertices,n=(t.push(i.buffer),e.indices);return t.push(n.buffer),{vertices:i.buffer,indices:n.buffer,numberOfAttributes:e.encoding.stride,minimumHeight:e.minimumHeight,maximumHeight:e.maximumHeight,boundingSphere3D:e.boundingSphere3D,orientedBoundingBox:e.orientedBoundingBox,occludeePointInScaledSpace:e.occludeePointInScaledSpace,encoding:e.encoding,vertexCountWithoutSkirts:e.vertexCountWithoutSkirts,indexCountWithoutSkirts:e.indexCountWithoutSkirts,westIndicesSouthToNorth:e.westIndicesSouthToNorth,southIndicesEastToWest:e.southIndicesEastToWest,eastIndicesNorthToSouth:e.eastIndicesNorthToSouth,northIndicesWestToEast:e.northIndicesWestToEast}})});
