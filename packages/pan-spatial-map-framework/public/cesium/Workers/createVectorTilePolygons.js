define(["./AttributeCompression-25f42564","./Cartesian2-38b35910","./Color-0fad516f","./when-ae2e0b60","./IndexDatatype-516320ea","./Math-5bbcea10","./OrientedBoundingBox-771a38ca","./createTaskProcessorWorker","./Check-f996273c","./Transforms-07a9fab5","./combine-276652d0","./RuntimeError-ac2797b4","./WebGLConstants-35626ea2","./EllipsoidTangentPlane-19622103","./AxisAlignedBoundingBox-d272def4","./IntersectionTests-f49c7cd3","./Plane-45ad3143"],function(ke,me,ye,Ie,we,xe,ve,e,a,n,r,t,i,o,s,f,d){"use strict";var Ae=new me.Cartesian3,Ee=new me.Ellipsoid,Ne=new me.Rectangle,Te={min:void 0,max:void 0,indexBytesPerElement:void 0};function Be(c,e,a){var n=e.length,u=2+n*ve.OrientedBoundingBox.packedLength+1+function(e){for(var a=e.length,n=0,r=0;r<a;++r)n+=ye.Color.packedLength+3+e[r].batchIds.length;return n}(a),r=new Float64Array(u),t=0;r[t++]=c,r[t++]=n;for(var i=0;i<n;++i)ve.OrientedBoundingBox.pack(e[i],r,t),t+=ve.OrientedBoundingBox.packedLength;var o=a.length;r[t++]=o;for(var s=0;s<o;++s){var f=a[s],h=(ye.Color.pack(f.color,r,t),t+=ye.Color.packedLength,r[t++]=f.offset,r[t++]=f.count,f.batchIds),l=h.length;r[t++]=l;for(var d=0;d<l;++d)r[t++]=h[d]}return r}var Le=new me.Cartesian3,Oe=new me.Cartesian3,Ue=new me.Cartesian3,Pe=new me.Cartesian3,Fe=new me.Cartesian3,Se=new me.Cartographic,Re=new me.Rectangle;return e(function(c,u){e=c.packedBuffer,e=new Float64Array(e),d=0,Te.indexBytesPerElement=e[d++],Te.min=e[d++],Te.max=e[d++],me.Cartesian3.unpack(e,3,Ae),d+=me.Cartesian3.packedLength,me.Ellipsoid.unpack(e,d,Ee),d+=me.Ellipsoid.packedLength,me.Rectangle.unpack(e,d,Ne);for(var h=new(2===Te.indexBytesPerElement?Uint16Array:Uint32Array)(c.indices),e=new Uint16Array(c.positions),l=new Uint32Array(c.counts),g=new Uint32Array(c.indexCounts),p=new Uint32Array(c.batchIds),b=new Uint32Array(c.batchTableColors),C=new Array(l.length),m=Ae,y=Ee,I=Ne,w=Te.min,x=Te.max,v=c.minimumHeights,A=c.maximumHeights,E=(Ie.defined(v)&&Ie.defined(A)&&(v=new Float32Array(v),A=new Float32Array(A)),e.length/2),N=e.subarray(0,E),T=e.subarray(E,2*E),k=(ke.AttributeCompression.zigZagDeltaDecode(N,T),new Float64Array(3*E)),a=0;a<E;++a){var B=N[a],L=T[a],B=xe.CesiumMath.lerp(I.west,I.east,B/32767),L=xe.CesiumMath.lerp(I.south,I.north,L/32767),B=me.Cartographic.fromRadians(B,L,0,Se),L=y.cartographicToCartesian(B,Le);me.Cartesian3.pack(L,k,3*a)}var O=l.length,U=new Array(O),P=new Array(O),F=0,S=0;for(a=0;a<O;++a)U[a]=F,P[a]=S,F+=l[a],S+=g[a];var R=new Float32Array(3*E*2),D=new Uint16Array(2*E),M=new Uint32Array(P.length),_=new Uint32Array(g.length),n=[],r={};for(a=0;a<O;++a)t=b[a],Ie.defined(r[t])?(r[t].positionLength+=l[a],r[t].indexLength+=g[a],r[t].batchIds.push(a)):r[t]={positionLength:l[a],indexLength:g[a],offset:0,indexOffset:0,batchIds:[a]};var G,Y=0,V=0;for(t in r)r.hasOwnProperty(t)&&((i=r[t]).offset=Y,i.indexOffset=V,Y+=2*i.positionLength,V+=G=2*i.indexLength+6*i.positionLength,i.indexLength=G);var H=[];for(t in r)r.hasOwnProperty(t)&&(i=r[t],H.push({color:ye.Color.fromRgba(parseInt(t)),offset:i.indexOffset,count:i.indexLength,batchIds:i.batchIds}));for(a=0;a<O;++a){for(var t,i,o=(i=r[t=b[a]]).offset,W=3*o,z=o,Z=U[a],j=l[a],q=p[a],J=w,K=x,Q=(Ie.defined(v)&&Ie.defined(A)&&(J=v[a],K=A[a]),Number.POSITIVE_INFINITY),X=Number.NEGATIVE_INFINITY,$=Number.POSITIVE_INFINITY,ee=Number.NEGATIVE_INFINITY,s=0;s<j;++s){var ae=me.Cartesian3.unpack(k,3*Z+3*s,Le),ne=(y.scaleToGeodeticSurface(ae,ae),y.cartesianToCartographic(ae,Se)),re=ne.latitude,ne=ne.longitude,Q=Math.min(re,Q),X=Math.max(re,X),$=Math.min(ne,$),ee=Math.max(ne,ee),re=y.geodeticSurfaceNormal(ae,Oe),ne=me.Cartesian3.multiplyByScalar(re,J,Ue),te=me.Cartesian3.add(ae,ne,Pe),ne=me.Cartesian3.multiplyByScalar(re,K,ne),re=me.Cartesian3.add(ae,ne,Fe);me.Cartesian3.subtract(re,m,re),me.Cartesian3.subtract(te,m,te),me.Cartesian3.pack(re,R,W),me.Cartesian3.pack(te,R,W+3),D[z]=q,D[z+1]=q,W+=6,z+=2}(I=Re).west=$,I.east=ee,I.south=Q,I.north=X,C[a]=ve.OrientedBoundingBox.fromRectangle(I,w,x,y);var f=i.indexOffset,ie=P[a],oe=g[a];for(M[a]=f,s=0;s<oe;s+=3){var se=h[ie+s]-Z,fe=h[ie+s+1]-Z,de=h[ie+s+2]-Z;n[f++]=2*se+o,n[f++]=2*fe+o,n[f++]=2*de+o,n[f++]=2*de+1+o,n[f++]=2*fe+1+o,n[f++]=2*se+1+o}for(s=0;s<j;++s){var ce=s,ue=(s+1)%j;n[f++]=2*ce+1+o,n[f++]=2*ue+o,n[f++]=2*ce+o,n[f++]=2*ce+1+o,n[f++]=2*ue+1+o,n[f++]=2*ue+o}i.offset+=2*j,i.indexOffset=f,_[a]=f-M[a]}for(var n=we.IndexDatatype.createTypedArray(R.length/3,n),he=H.length,le=0;le<he;++le){for(var ge=H[le].batchIds,pe=0,be=ge.length,Ce=0;Ce<be;++Ce)pe+=_[ge[Ce]];H[le].count=pe}var d=Be(2===n.BYTES_PER_ELEMENT?we.IndexDatatype.UNSIGNED_SHORT:we.IndexDatatype.UNSIGNED_INT,C,H);return u.push(R.buffer,n.buffer,M.buffer,_.buffer,D.buffer,d.buffer),{positions:R.buffer,indices:n.buffer,indexOffsets:M.buffer,indexCounts:_.buffer,batchIds:D.buffer,packedBuffer:d.buffer}})});
